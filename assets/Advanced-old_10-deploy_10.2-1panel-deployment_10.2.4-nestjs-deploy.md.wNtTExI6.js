import{_ as k,C as r,c as o,o as n,j as a,b as l,a3 as p,a as i,w as t,G as h,a4 as d}from"./chunks/framework.CUcrqFol.js";const D=JSON.parse('{"title":"10.2.4 NestJS 项目怎么部署——NestJS 部署示例：API 服务与数据库连接","description":"10.2.4 NestJS 项目怎么部署——NestJS 部署示例：API 服务与数据库连接 NestJS 部署的核心：编译 TypeScript，连接数据库。 部署流程概览 步骤一：编写 Dockerfile 在项目根目录创建 ： 与 Next.js Dockerfile 的区别 | 差异点 | Next.js |","frontmatter":{"title":"10.2.4 NestJS 项目怎么部署——NestJS 部署示例：API 服务与数据库连接","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/10-deploy/10.2-1panel-deployment/10.2.4-nestjs-deploy.md","filePath":"Advanced-old/10-deploy/10.2-1panel-deployment/10.2.4-nestjs-deploy.md","lastUpdated":1766168364000}'),E={name:"Advanced-old/10-deploy/10.2-1panel-deployment/10.2.4-nestjs-deploy.md"};function c(g,s,y,A,F,u){const e=r("Mermaid");return n(),o("div",null,[s[2]||(s[2]=a("h1",{id:"_10-2-4-nestjs-项目怎么部署——nestjs-部署示例-api-服务与数据库连接",tabindex:"-1"},[i("10.2.4 NestJS 项目怎么部署——NestJS 部署示例：API 服务与数据库连接 "),a("a",{class:"header-anchor",href:"#_10-2-4-nestjs-项目怎么部署——nestjs-部署示例-api-服务与数据库连接","aria-label":'Permalink to "10.2.4 NestJS 项目怎么部署——NestJS 部署示例：API 服务与数据库连接"'},"​")],-1)),s[3]||(s[3]=a("p",null,"NestJS 部署的核心：编译 TypeScript，连接数据库。",-1)),s[4]||(s[4]=a("h2",{id:"部署流程概览",tabindex:"-1"},[i("部署流程概览 "),a("a",{class:"header-anchor",href:"#部署流程概览","aria-label":'Permalink to "部署流程概览"'},"​")],-1)),(n(),l(d,null,{default:t(()=>[h(e,{id:"mermaid-9",class:"mermaid",graph:"flowchart%20LR%0A%20%20%20%20A%5BTypeScript%E6%BA%90%E7%A0%81%5D%20--%3E%20B%5B%E7%BC%96%E8%AF%91%E4%B8%BAJS%5D%0A%20%20%20%20B%20--%3E%20C%5B%E6%9E%84%E5%BB%BADocker%E9%95%9C%E5%83%8F%5D%0A%20%20%20%20C%20--%3E%20D%5B%E9%83%A8%E7%BD%B2%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%5D%0A%20%20%20%20D%20--%3E%20E%5B%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%5D%0A%20%20%20%20E%20--%3E%20F%5B%E8%BF%90%E8%A1%8C%E8%BF%81%E7%A7%BB%5D%0A%20%20%20%20F%20--%3E%20G%5B%E6%9C%8D%E5%8A%A1%E5%B0%B1%E7%BB%AA%5D%0A"})]),fallback:t(()=>[...s[0]||(s[0]=[i(" Loading... ",-1)])]),_:1})),s[5]||(s[5]=p(`<h2 id="步骤一-编写-dockerfile" tabindex="-1">步骤一：编写 Dockerfile <a class="header-anchor" href="#步骤一-编写-dockerfile" aria-label="Permalink to &quot;步骤一：编写 Dockerfile&quot;">​</a></h2><p>在项目根目录创建 <code>Dockerfile</code>：</p><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 构建阶段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> node:18-alpine </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装依赖</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> package*.json ./</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> npm ci</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 复制源码并编译</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> . .</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> npm run build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 生产阶段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> node:18-alpine </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> runner</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NODE_ENV=production</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 只复制生产依赖</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> package*.json ./</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> npm ci --only=production</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 复制编译产物</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=builder /app/dist ./dist</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 复制 Prisma 相关文件（如果使用 Prisma）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=builder /app/prisma ./prisma</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> npx prisma generate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EXPOSE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 3001</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;node&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dist/main.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h3 id="与-next-js-dockerfile-的区别" tabindex="-1">与 Next.js Dockerfile 的区别 <a class="header-anchor" href="#与-next-js-dockerfile-的区别" aria-label="Permalink to &quot;与 Next.js Dockerfile 的区别&quot;">​</a></h3><table tabindex="0"><thead><tr><th>差异点</th><th>Next.js</th><th>NestJS</th></tr></thead><tbody><tr><td>输出目录</td><td><code>.next/standalone</code></td><td><code>dist</code></td></tr><tr><td>启动命令</td><td><code>node server.js</code></td><td><code>node dist/main.js</code></td></tr><tr><td>ORM 配置</td><td>通常无</td><td>需要 Prisma generate</td></tr><tr><td>端口</td><td>3000</td><td>3001</td></tr></tbody></table><h2 id="步骤二-配置数据库连接" tabindex="-1">步骤二：配置数据库连接 <a class="header-anchor" href="#步骤二-配置数据库连接" aria-label="Permalink to &quot;步骤二：配置数据库连接&quot;">​</a></h2><h3 id="环境变量设置" tabindex="-1">环境变量设置 <a class="header-anchor" href="#环境变量设置" aria-label="Permalink to &quot;环境变量设置&quot;">​</a></h3><div class="language-env vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">env</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .env.production</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DATABASE_URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;postgresql://user:password@postgres:5432/mydb?schema=public&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REDIS_URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;redis://redis:6379&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JWT_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;your-production-secret&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=3001</span></span></code></pre></div><h3 id="容器网络配置" tabindex="-1">容器网络配置 <a class="header-anchor" href="#容器网络配置" aria-label="Permalink to &quot;容器网络配置&quot;">​</a></h3><p>在 1Panel 中，确保 NestJS 容器和数据库容器在同一网络：</p>`,10)),(n(),l(d,null,{default:t(()=>[h(e,{id:"mermaid-94",class:"mermaid",graph:"flowchart%20TB%0A%20%20%20%20subgraph%20Docker%E7%BD%91%E7%BB%9C%0A%20%20%20%20%20%20%20%20A%5BNestJS%E5%AE%B9%E5%99%A8%5D%20--%3E%20B%5BPostgreSQL%E5%AE%B9%E5%99%A8%5D%0A%20%20%20%20%20%20%20%20A%20--%3E%20C%5BRedis%E5%AE%B9%E5%99%A8%5D%0A%20%20%20%20end%0A%20%20%20%20D%5B%E5%A4%96%E9%83%A8%E8%AF%B7%E6%B1%82%5D%20--%3E%20A%0A"})]),fallback:t(()=>[...s[1]||(s[1]=[i(" Loading... ",-1)])]),_:1})),s[6]||(s[6]=p(`<div class="tip custom-block"><p class="custom-block-title">容器间通信</p><p>在同一 Docker 网络中，可以用<strong>容器名</strong>作为主机名。例如数据库容器名为 <code>postgres</code>，连接地址就是 <code>postgres:5432</code>。</p></div><h2 id="步骤三-在-1panel-中部署" tabindex="-1">步骤三：在 1Panel 中部署 <a class="header-anchor" href="#步骤三-在-1panel-中部署" aria-label="Permalink to &quot;步骤三：在 1Panel 中部署&quot;">​</a></h2><h3 id="容器配置" tabindex="-1">容器配置 <a class="header-anchor" href="#容器配置" aria-label="Permalink to &quot;容器配置&quot;">​</a></h3><table tabindex="0"><thead><tr><th>配置项</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td>镜像</td><td><code>registry.cn-hangzhou.aliyuncs.com/xxx/my-nestjs-api:v1.0.0</code></td><td>完整镜像地址</td></tr><tr><td>容器名</td><td><code>nestjs-api</code></td><td>便于识别</td></tr><tr><td>端口映射</td><td><code>3001:3001</code></td><td>外部:内部</td></tr><tr><td>网络</td><td><code>1panel-network</code></td><td>与数据库同网络</td></tr><tr><td>重启策略</td><td><code>always</code></td><td>崩溃自动重启</td></tr></tbody></table><h3 id="环境变量配置" tabindex="-1">环境变量配置 <a class="header-anchor" href="#环境变量配置" aria-label="Permalink to &quot;环境变量配置&quot;">​</a></h3><table tabindex="0"><thead><tr><th>变量名</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td><code>NODE_ENV</code></td><td><code>production</code></td><td>生产模式</td></tr><tr><td><code>DATABASE_URL</code></td><td><code>postgresql://...</code></td><td>数据库连接串</td></tr><tr><td><code>REDIS_URL</code></td><td><code>redis://redis:6379</code></td><td>Redis 连接串</td></tr><tr><td><code>JWT_SECRET</code></td><td><code>xxx</code></td><td>JWT 密钥</td></tr><tr><td><code>PORT</code></td><td><code>3001</code></td><td>监听端口</td></tr></tbody></table><h3 id="启动顺序配置" tabindex="-1">启动顺序配置 <a class="header-anchor" href="#启动顺序配置" aria-label="Permalink to &quot;启动顺序配置&quot;">​</a></h3><p>NestJS 依赖数据库，需要确保数据库先启动：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># docker-compose.yml 示例</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  api</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    depends_on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      postgres</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        condition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">service_healthy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      redis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        condition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">service_started</span></span></code></pre></div><h2 id="步骤四-数据库迁移" tabindex="-1">步骤四：数据库迁移 <a class="header-anchor" href="#步骤四-数据库迁移" aria-label="Permalink to &quot;步骤四：数据库迁移&quot;">​</a></h2><h3 id="方式一-启动时自动迁移" tabindex="-1">方式一：启动时自动迁移 <a class="header-anchor" href="#方式一-启动时自动迁移" aria-label="Permalink to &quot;方式一：启动时自动迁移&quot;">​</a></h3><p>修改启动命令：</p><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sh&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npx prisma migrate deploy &amp;&amp; node dist/main.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h3 id="方式二-手动执行迁移" tabindex="-1">方式二：手动执行迁移 <a class="header-anchor" href="#方式二-手动执行迁移" aria-label="Permalink to &quot;方式二：手动执行迁移&quot;">​</a></h3><p>进入容器执行：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 进入容器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nestjs-api</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 执行迁移</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prisma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可选：执行种子数据</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prisma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seed</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">生产环境迁移注意</p><ul><li>始终使用 <code>migrate deploy</code> 而非 <code>migrate dev</code></li><li>迁移前备份数据库</li><li>破坏性迁移需要维护窗口</li></ul></div><h2 id="步骤五-配置反向代理" tabindex="-1">步骤五：配置反向代理 <a class="header-anchor" href="#步骤五-配置反向代理" aria-label="Permalink to &quot;步骤五：配置反向代理&quot;">​</a></h2><p>在 1Panel 的 <strong>网站</strong> 中配置 API 子域名：</p><table tabindex="0"><thead><tr><th>配置项</th><th>值</th></tr></thead><tbody><tr><td>域名</td><td><code>api.example.com</code></td></tr><tr><td>代理地址</td><td><code>127.0.0.1:3001</code></td></tr><tr><td>HTTPS</td><td>开启</td></tr></tbody></table><h3 id="nginx-配置示例" tabindex="-1">Nginx 配置示例 <a class="header-anchor" href="#nginx-配置示例" aria-label="Permalink to &quot;Nginx 配置示例&quot;">​</a></h3><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">443</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ssl http2;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">api.example.com;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ssl_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/path/to/cert.pem;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ssl_certificate_key </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/path/to/key.pem;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://127.0.0.1:3001;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_http_version </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Host $host;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Real-IP $remote_addr;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Forwarded-Proto $scheme;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 支持 WebSocket（如果需要）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Upgrade $http_upgrade;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connection </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;upgrade&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="健康检查" tabindex="-1">健康检查 <a class="header-anchor" href="#健康检查" aria-label="Permalink to &quot;健康检查&quot;">​</a></h2><h3 id="添加健康检查端点" tabindex="-1">添加健康检查端点 <a class="header-anchor" href="#添加健康检查端点" aria-label="Permalink to &quot;添加健康检查端点&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/health/health.controller.ts</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Controller</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;health&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HealthController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  @</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  check</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ok&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, timestamp: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toISOString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="docker-健康检查配置" tabindex="-1">Docker 健康检查配置 <a class="header-anchor" href="#docker-健康检查配置" aria-label="Permalink to &quot;Docker 健康检查配置&quot;">​</a></h3><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HEALTHCHECK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --interval=30s --timeout=10s --start-period=5s --retries=3 \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> curl -f http://localhost:3001/health || exit 1</span></span></code></pre></div><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h2><table tabindex="0"><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>数据库连接失败</td><td>网络不通或凭证错误</td><td>检查容器网络和环境变量</td></tr><tr><td>Prisma Client 未生成</td><td>镜像构建时未执行 generate</td><td>Dockerfile 中添加 <code>prisma generate</code></td></tr><tr><td>启动超时</td><td>等待数据库就绪</td><td>添加健康检查和重试逻辑</td></tr><tr><td>内存不足</td><td>Node.js 默认内存限制</td><td>设置 <code>NODE_OPTIONS=--max-old-space-size=2048</code></td></tr></tbody></table><h2 id="ai-协作指南" tabindex="-1">AI 协作指南 <a class="header-anchor" href="#ai-协作指南" aria-label="Permalink to &quot;AI 协作指南&quot;">​</a></h2><p>向 AI 描述 NestJS 部署问题时：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>我的 NestJS + Prisma 应用部署后无法连接数据库，</span></span>
<span class="line"><span>使用 PostgreSQL，部署在 1Panel，</span></span>
<span class="line"><span>错误信息：Can&#39;t reach database server at &#39;postgres:5432&#39;</span></span>
<span class="line"><span>请帮我排查原因。</span></span></code></pre></div><p><strong>关键术语</strong>：Prisma migrate deploy、Docker 网络、容器间通信、健康检查</p>`,33))])}const m=k(E,[["render",c]]);export{D as __pageData,m as default};
