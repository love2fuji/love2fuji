import{_ as t,C as h,c as p,o as i,a3 as a,b as k,w as n,a as e,G as E,a4 as r}from"./chunks/framework.CUcrqFol.js";const C=JSON.parse('{"title":"11.4.3 怎么彻底解决——修复方案：临时修复与根本解决","description":"11.4.3 修复方案：临时修复与根本解决 一句话破题 修复分两步：先**止血**（临时方案快速恢复服务），再**根治**（根本方案彻底解决问题）。 核心价值 区分临时和根本方案能让你： 快速恢复服务，减少影响 不因赶时间而留下技术债 有计划地彻底解决问题 临时方案 vs 根本方案 | 对比项 | 临时方案 | 根本方","frontmatter":{"title":"11.4.3 怎么彻底解决——修复方案：临时修复与根本解决","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/11-review/11.4-post-mortem/11.4.3-fix.md","filePath":"Advanced-old/11-review/11.4-post-mortem/11.4.3-fix.md","lastUpdated":1766168364000}'),d={name:"Advanced-old/11-review/11.4-post-mortem/11.4.3-fix.md"};function o(g,s,c,y,F,A){const l=h("Mermaid");return i(),p("div",null,[s[1]||(s[1]=a(`<h1 id="_11-4-3-修复方案-临时修复与根本解决" tabindex="-1">11.4.3 修复方案：临时修复与根本解决 <a class="header-anchor" href="#_11-4-3-修复方案-临时修复与根本解决" aria-label="Permalink to &quot;11.4.3 修复方案：临时修复与根本解决&quot;">​</a></h1><h2 id="一句话破题" tabindex="-1">一句话破题 <a class="header-anchor" href="#一句话破题" aria-label="Permalink to &quot;一句话破题&quot;">​</a></h2><p>修复分两步：先<strong>止血</strong>（临时方案快速恢复服务），再<strong>根治</strong>（根本方案彻底解决问题）。</p><h2 id="核心价值" tabindex="-1">核心价值 <a class="header-anchor" href="#核心价值" aria-label="Permalink to &quot;核心价值&quot;">​</a></h2><p>区分临时和根本方案能让你：</p><ul><li>快速恢复服务，减少影响</li><li>不因赶时间而留下技术债</li><li>有计划地彻底解决问题</li></ul><h2 id="临时方案-vs-根本方案" tabindex="-1">临时方案 vs 根本方案 <a class="header-anchor" href="#临时方案-vs-根本方案" aria-label="Permalink to &quot;临时方案 vs 根本方案&quot;">​</a></h2><table tabindex="0"><thead><tr><th>对比项</th><th>临时方案</th><th>根本方案</th></tr></thead><tbody><tr><td><strong>目标</strong></td><td>快速恢复服务</td><td>彻底解决问题</td></tr><tr><td><strong>时间</strong></td><td>分钟级</td><td>天/周级</td></tr><tr><td><strong>风险</strong></td><td>可能有副作用</td><td>经过充分测试</td></tr><tr><td><strong>适用</strong></td><td>紧急止血</td><td>长期稳定</td></tr></tbody></table><h2 id="临时方案示例" tabindex="-1">临时方案示例 <a class="header-anchor" href="#临时方案示例" aria-label="Permalink to &quot;临时方案示例&quot;">​</a></h2><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 问题：数据库连接池耗尽</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 临时方案1：重启服务（最快）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pm2 restart all</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 临时方案2：增加连接数（快速配置）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DATABASE_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;...?connection_limit=50&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 临时方案3：降级处理（保核心功能）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> login</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">credentials</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LoginCredentials</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> normalLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(credentials)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isDatabaseOverload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(error)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 临时降级：使用缓存验证</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fallbackLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(credentials)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="根本方案示例" tabindex="-1">根本方案示例 <a class="header-anchor" href="#根本方案示例" aria-label="Permalink to &quot;根本方案示例&quot;">​</a></h2><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 根本方案1：添加数据库索引</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// prisma/migrations/xxx_add_user_email_index.sql</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CREATE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> INDEX</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> idx_user_email </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ON</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(email);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 根本方案2：优化查询</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prisma.user.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findFirst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  where: { email },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  select: { id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, email: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, passwordHash: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 根本方案3：添加连接池监控</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  connectionString: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DATABASE_URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  max: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  idleTimeoutMillis: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  connectionTimeoutMillis: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Database pool error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">increment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;db.pool.error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h2 id="修复方案模板" tabindex="-1">修复方案模板 <a class="header-anchor" href="#修复方案模板" aria-label="Permalink to &quot;修复方案模板&quot;">​</a></h2><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">## 修复方案</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">### 临时方案（已执行）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold;">**操作**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">：重启数据库服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold;">**时间**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">：10:25</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold;">**效果**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">：服务恢复正常</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-light-font-weight:bold;--shiki-dark:#E1E4E8;--shiki-dark-font-weight:bold;">**风险**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">：可能再次发生</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">### 根本方案（待实施）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| 措施 | 负责人 | 完成时间 | 验证方式 |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|------|--------|----------|----------|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| 添加 email 字段索引 | 张三 | 1月20日 | 查询时间 &lt; 100ms |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| 配置连接池监控 | 李四 | 1月22日 | Grafana 看板 |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| 添加慢查询告警 | 王五 | 1月25日 | 告警触发测试 |</span></span></code></pre></div><h2 id="修复优先级矩阵" tabindex="-1">修复优先级矩阵 <a class="header-anchor" href="#修复优先级矩阵" aria-label="Permalink to &quot;修复优先级矩阵&quot;">​</a></h2>`,15)),(i(),k(r,null,{default:n(()=>[E(l,{id:"mermaid-111",class:"mermaid",graph:"quadrantChart%0A%20%20%20%20title%20%E4%BF%AE%E5%A4%8D%E4%BC%98%E5%85%88%E7%BA%A7%E7%9F%A9%E9%98%B5%0A%20%20%20%20x-axis%20%E5%AE%9E%E6%96%BD%E9%9A%BE%E5%BA%A6%E4%BD%8E%20--%3E%20%E5%AE%9E%E6%96%BD%E9%9A%BE%E5%BA%A6%E9%AB%98%0A%20%20%20%20y-axis%20%E5%BD%B1%E5%93%8D%E7%A8%8B%E5%BA%A6%E4%BD%8E%20--%3E%20%E5%BD%B1%E5%93%8D%E7%A8%8B%E5%BA%A6%E9%AB%98%0A%20%20%20%20quadrant-1%20%E4%BC%98%E5%85%88%E5%AE%9E%E6%96%BD%0A%20%20%20%20quadrant-2%20%E8%AE%A1%E5%88%92%E5%AE%9E%E6%96%BD%0A%20%20%20%20quadrant-3%20%E6%8B%A9%E6%9C%BA%E5%AE%9E%E6%96%BD%0A%20%20%20%20quadrant-4%20%E6%9A%82%E7%BC%93%E5%AE%9E%E6%96%BD%0A%20%20%20%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%3A%20%5B0.2%2C%200.8%5D%0A%20%20%20%20%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7%3A%20%5B0.3%2C%200.6%5D%0A%20%20%20%20%E6%9E%B6%E6%9E%84%E9%87%8D%E6%9E%84%3A%20%5B0.8%2C%200.9%5D%0A%20%20%20%20%E4%BC%98%E5%8C%96%E6%97%A5%E5%BF%97%3A%20%5B0.2%2C%200.3%5D%0A"})]),fallback:n(()=>[...s[0]||(s[0]=[e(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=a(`<h2 id="回滚计划" tabindex="-1">回滚计划 <a class="header-anchor" href="#回滚计划" aria-label="Permalink to &quot;回滚计划&quot;">​</a></h2><p>每个修复方案都应该有回滚计划：</p><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">## 回滚计划</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">### 索引修复</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 回滚命令：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\`DROP INDEX idx_user_email;\`</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 回滚时间：&lt; 1 分钟</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 回滚影响：查询变慢</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">### 配置变更</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 回滚方式：恢复旧的环境变量</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 回滚命令：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\`kubectl rollout undo deployment/api\`</span></span></code></pre></div><h2 id="避坑指南" tabindex="-1">避坑指南 <a class="header-anchor" href="#避坑指南" aria-label="Permalink to &quot;避坑指南&quot;">​</a></h2><div class="danger custom-block"><p class="custom-block-title">新手最容易犯的错</p><ol><li>只做临时方案，忘了根本方案</li><li>根本方案太激进，引入新问题</li><li>没有准备回滚计划</li><li>修复后没有验证效果</li></ol></div>`,5))])}const u=t(d,[["render",o]]);export{C as __pageData,u as default};
