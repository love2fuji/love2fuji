import{_ as h,C as e,c as p,o as t,j as i,b as k,a3 as d,a,w as n,G as r,a4 as E}from"./chunks/framework.CUcrqFol.js";const D=JSON.parse('{"title":"9.4 出了错如何快速定位——错误处理与日志规范：级别/上下文/脱敏；修复 → 文档同步","description":"9.4 出了错如何快速定位——错误处理与日志规范：级别/上下文/脱敏；修复 → 文档同步 **好的日志是生产环境的\\"黑匣子\\"——出问题时能快速定位，平时不碍事。** 日志系统架构 本章内容 | 小节 | 主题 | 核心内容 | |------|------|----------| | 9.4.1 | 日志级别 | ER","frontmatter":{"title":"9.4 出了错如何快速定位——错误处理与日志规范：级别/上下文/脱敏；修复 → 文档同步","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/09-testing/9.4-logging/index.md","filePath":"Advanced-old/09-testing/9.4-logging/index.md","lastUpdated":1766168364000}'),o={name:"Advanced-old/09-testing/9.4-logging/index.md"};function g(F,s,y,c,B,A){const l=e("Mermaid");return t(),p("div",null,[s[1]||(s[1]=i("h1",{id:"_9-4-出了错如何快速定位——错误处理与日志规范-级别-上下文-脱敏-修复-→-文档同步",tabindex:"-1"},[a("9.4 出了错如何快速定位——错误处理与日志规范：级别/上下文/脱敏；修复 → 文档同步 "),i("a",{class:"header-anchor",href:"#_9-4-出了错如何快速定位——错误处理与日志规范-级别-上下文-脱敏-修复-→-文档同步","aria-label":'Permalink to "9.4 出了错如何快速定位——错误处理与日志规范：级别/上下文/脱敏；修复 → 文档同步"'},"​")],-1)),s[2]||(s[2]=i("p",null,[i("strong",null,'好的日志是生产环境的"黑匣子"——出问题时能快速定位，平时不碍事。')],-1)),s[3]||(s[3]=i("h2",{id:"日志系统架构",tabindex:"-1"},[a("日志系统架构 "),i("a",{class:"header-anchor",href:"#日志系统架构","aria-label":'Permalink to "日志系统架构"'},"​")],-1)),(t(),k(E,null,{default:n(()=>[r(l,{id:"mermaid-9",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20A%5B%E5%BA%94%E7%94%A8%E4%BB%A3%E7%A0%81%5D%20--%3E%20B%5B%E6%97%A5%E5%BF%97%E5%BA%93%5D%0A%20%20%20%20B%20--%3E%20C%7B%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB%7D%0A%20%20%20%20C%20--%3E%7CERROR%7C%20D%5B%E9%94%99%E8%AF%AF%E8%BF%BD%E8%B8%AA%5D%0A%20%20%20%20C%20--%3E%7CWARN%7C%20E%5B%E5%91%8A%E8%AD%A6%E7%B3%BB%E7%BB%9F%5D%0A%20%20%20%20C%20--%3E%7CINFO%7C%20F%5B%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%5D%0A%20%20%20%20C%20--%3E%7CDEBUG%7C%20G%5B%E8%B0%83%E8%AF%95%E6%97%A5%E5%BF%97%5D%0A%20%20%20%20%0A%20%20%20%20D%20--%3E%20H%5BSentry%2FDatadog%5D%0A%20%20%20%20E%20--%3E%20I%5BPagerDuty%2F%E9%92%89%E9%92%89%5D%0A%20%20%20%20F%20--%3E%20J%5BCloudWatch%2FELK%5D%0A%20%20%20%20G%20--%3E%20K%5B%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%5D%0A"})]),fallback:n(()=>[...s[0]||(s[0]=[a(" Loading... ",-1)])]),_:1})),s[4]||(s[4]=d(`<h2 id="本章内容" tabindex="-1">本章内容 <a class="header-anchor" href="#本章内容" aria-label="Permalink to &quot;本章内容&quot;">​</a></h2><table tabindex="0"><thead><tr><th>小节</th><th>主题</th><th>核心内容</th></tr></thead><tbody><tr><td>9.4.1</td><td>日志级别</td><td>ERROR/WARN/INFO/DEBUG 的正确使用</td></tr><tr><td>9.4.2</td><td>上下文信息</td><td>请求 ID、用户 ID、操作类型的注入</td></tr><tr><td>9.4.3</td><td>敏感信息脱敏</td><td>密码、Token、身份证号的安全处理</td></tr><tr><td>9.4.4</td><td>错误恢复</td><td>异常处理与用户友好提示</td></tr><tr><td>9.4.5</td><td>文档同步</td><td>错误码文档的维护与更新</td></tr></tbody></table><h2 id="日志库选择" tabindex="-1">日志库选择 <a class="header-anchor" href="#日志库选择" aria-label="Permalink to &quot;日志库选择&quot;">​</a></h2><table tabindex="0"><thead><tr><th>库</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td>pino</td><td>高性能 JSON 日志</td><td>生产环境</td></tr><tr><td>winston</td><td>功能丰富，可扩展</td><td>复杂需求</td></tr><tr><td>console</td><td>零依赖</td><td>开发调试</td></tr></tbody></table><h2 id="快速配置" tabindex="-1">快速配置 <a class="header-anchor" href="#快速配置" aria-label="Permalink to &quot;快速配置&quot;">​</a></h2><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lib/logger.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pino </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;pino&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> logger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pino</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  level: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">LOG_LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;info&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  transport: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NODE_ENV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;development&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { target: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;pino-pretty&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  redact: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;password&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;token&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;authorization&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { logger } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@/lib/logger&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 记录不同级别的日志</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ err, userId }, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;支付处理失败&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ orderId }, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;库存不足，已降级处理&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ action: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;login&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, userId }, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;用户登录&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ query }, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;数据库查询&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h2 id="核心原则" tabindex="-1">核心原则 <a class="header-anchor" href="#核心原则" aria-label="Permalink to &quot;核心原则&quot;">​</a></h2><ol><li><strong>生产环境只记录 INFO 及以上</strong>：DEBUG 日志量太大</li><li><strong>结构化日志</strong>：使用 JSON 格式，便于搜索和聚合</li><li><strong>敏感信息必须脱敏</strong>：密码、Token、个人信息</li><li><strong>错误要有上下文</strong>：谁、在哪、做什么、为什么失败</li><li><strong>文档与代码同步</strong>：错误码变更时更新文档</li></ol><h2 id="本节小结" tabindex="-1">本节小结 <a class="header-anchor" href="#本节小结" aria-label="Permalink to &quot;本节小结&quot;">​</a></h2><p>日志是生产环境的&quot;眼睛&quot;。通过分级记录、结构化输出、敏感信息脱敏，让日志既能帮助排查问题，又不会泄露用户隐私。接下来的小节会详细讲解每个方面的实现细节。</p>`,11))])}const u=h(o,[["render",g]]);export{D as __pageData,u as default};
