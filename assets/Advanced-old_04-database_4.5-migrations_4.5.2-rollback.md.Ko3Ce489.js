import{_ as l,C as h,c as p,o as a,a3 as i,b as e,w as n,a as k,G as d,a4 as r}from"./chunks/framework.CUcrqFol.js";const B=JSON.parse('{"title":"4.5.2 手术失败了怎么办——回滚机制：迁移失败的恢复方案","description":"4.5.2 手术失败了怎么办——回滚机制：迁移失败的恢复方案 一句话破题 Prisma 没有内置回滚命令——你需要自己准备回滚脚本或恢复备份。 回滚策略 预防措施：备份 **PostgreSQL 备份**： **Supabase 备份**： 自动每日备份（Pro 计划） 手动备份：Dashboard → Databas","frontmatter":{"title":"4.5.2 手术失败了怎么办——回滚机制：迁移失败的恢复方案","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/04-database/4.5-migrations/4.5.2-rollback.md","filePath":"Advanced-old/04-database/4.5-migrations/4.5.2-rollback.md","lastUpdated":1766168364000}'),o={name:"Advanced-old/04-database/4.5-migrations/4.5.2-rollback.md"};function g(c,s,F,E,y,b){const t=h("Mermaid");return a(),p("div",null,[s[1]||(s[1]=i('<h1 id="_4-5-2-手术失败了怎么办——回滚机制-迁移失败的恢复方案" tabindex="-1">4.5.2 手术失败了怎么办——回滚机制：迁移失败的恢复方案 <a class="header-anchor" href="#_4-5-2-手术失败了怎么办——回滚机制-迁移失败的恢复方案" aria-label="Permalink to &quot;4.5.2 手术失败了怎么办——回滚机制：迁移失败的恢复方案&quot;">​</a></h1><h3 id="一句话破题" tabindex="-1">一句话破题 <a class="header-anchor" href="#一句话破题" aria-label="Permalink to &quot;一句话破题&quot;">​</a></h3><p>Prisma 没有内置回滚命令——你需要自己准备回滚脚本或恢复备份。</p><h3 id="回滚策略" tabindex="-1">回滚策略 <a class="header-anchor" href="#回滚策略" aria-label="Permalink to &quot;回滚策略&quot;">​</a></h3>',4)),(a(),e(r,null,{default:n(()=>[d(t,{id:"mermaid-12",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20A%5B%22%E8%BF%81%E7%A7%BB%E5%A4%B1%E8%B4%A5%22%5D%20--%3E%20B%7B%22%E6%9C%89%E5%A4%87%E4%BB%BD%E5%90%97%EF%BC%9F%22%7D%0A%20%20%20%20B%20--%20%22%E6%9C%89%22%20--%3E%20C%5B%22%E6%81%A2%E5%A4%8D%E5%A4%87%E4%BB%BD%22%5D%0A%20%20%20%20B%20--%20%22%E6%B2%A1%E6%9C%89%22%20--%3E%20D%5B%22%E6%89%8B%E5%8A%A8%E5%9B%9E%E6%BB%9A%22%5D%0A%20%20%20%20D%20--%3E%20E%5B%22%E7%BC%96%E5%86%99%E5%8F%8D%E5%90%91%20SQL%22%5D%0A%20%20%20%20D%20--%3E%20F%5B%22%E5%88%9B%E5%BB%BA%E5%9B%9E%E6%BB%9A%E8%BF%81%E7%A7%BB%22%5D%0A"})]),fallback:n(()=>[...s[0]||(s[0]=[k(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=i(`<h3 id="预防措施-备份" tabindex="-1">预防措施：备份 <a class="header-anchor" href="#预防措施-备份" aria-label="Permalink to &quot;预防措施：备份&quot;">​</a></h3><p><strong>PostgreSQL 备份</strong>：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 备份</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pg_dump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -U</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup_</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">date</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +%Y%m%d_%H%M%S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.sql</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 恢复</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">psql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -U</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup_20240101_120000.sql</span></span></code></pre></div><p><strong>Supabase 备份</strong>：</p><ul><li>自动每日备份（Pro 计划）</li><li>手动备份：Dashboard → Database → Backups</li></ul><h3 id="回滚方案一-恢复备份" tabindex="-1">回滚方案一：恢复备份 <a class="header-anchor" href="#回滚方案一-恢复备份" aria-label="Permalink to &quot;回滚方案一：恢复备份&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 停止应用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 恢复数据库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">psql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -U</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> postgres</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> backup.sql</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 回退代码版本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> checkout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">previous-commi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 4. 重新部署</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span></span></code></pre></div><h3 id="回滚方案二-手动回滚迁移" tabindex="-1">回滚方案二：手动回滚迁移 <a class="header-anchor" href="#回滚方案二-手动回滚迁移" aria-label="Permalink to &quot;回滚方案二：手动回滚迁移&quot;">​</a></h3><p><strong>创建反向迁移</strong>：</p><p>假设原迁移是添加字段：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 原迁移</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN avatar </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>创建回滚迁移：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prisma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --create-only</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rollback_avatar</span></span></code></pre></div><p>编辑生成的 SQL：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 回滚迁移</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DROP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN avatar;</span></span></code></pre></div><p>应用回滚：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prisma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span></span></code></pre></div><h3 id="回滚方案三-标记迁移失败" tabindex="-1">回滚方案三：标记迁移失败 <a class="header-anchor" href="#回滚方案三-标记迁移失败" aria-label="Permalink to &quot;回滚方案三：标记迁移失败&quot;">​</a></h3><p>如果迁移执行了一半失败：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 标记迁移为已回滚</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prisma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> resolve</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --rolled-back</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;20240101120000_failed_migration&quot;</span></span></code></pre></div><p>然后修复迁移文件后重新执行。</p><h3 id="安全迁移模式" tabindex="-1">安全迁移模式 <a class="header-anchor" href="#安全迁移模式" aria-label="Permalink to &quot;安全迁移模式&quot;">​</a></h3><p><strong>分阶段迁移</strong>（避免破坏性变更）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>阶段 1: 添加新字段（可空）</span></span>
<span class="line"><span>阶段 2: 数据迁移</span></span>
<span class="line"><span>阶段 3: 设置默认值/非空约束</span></span>
<span class="line"><span>阶段 4: 删除旧字段</span></span></code></pre></div><p><strong>示例：重命名字段</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 阶段 1: 添加新字段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN full_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TEXT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 阶段 2: 数据迁移</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> full_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 阶段 3: 删除旧字段（下次迁移）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DROP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COLUMN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h3 id="迁移失败常见原因" tabindex="-1">迁移失败常见原因 <a class="header-anchor" href="#迁移失败常见原因" aria-label="Permalink to &quot;迁移失败常见原因&quot;">​</a></h3><table tabindex="0"><thead><tr><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>数据不符合新约束</td><td>先清理数据再迁移</td></tr><tr><td>锁表超时</td><td>在低峰期执行</td></tr><tr><td>磁盘空间不足</td><td>清理空间或扩容</td></tr><tr><td>权限不足</td><td>检查数据库用户权限</td></tr></tbody></table><h3 id="回滚检查清单" tabindex="-1">回滚检查清单 <a class="header-anchor" href="#回滚检查清单" aria-label="Permalink to &quot;回滚检查清单&quot;">​</a></h3><ul><li>[ ] 迁移前已备份数据库</li><li>[ ] 已准备回滚 SQL 脚本</li><li>[ ] 已记录当前应用版本</li><li>[ ] 已通知相关人员</li><li>[ ] 已准备回滚后的验证步骤</li></ul><h3 id="本节小结" tabindex="-1">本节小结 <a class="header-anchor" href="#本节小结" aria-label="Permalink to &quot;本节小结&quot;">​</a></h3><ul><li>Prisma 没有自动回滚，需手动准备</li><li>生产迁移前必须备份</li><li>大变更拆分成多个小迁移</li><li>准备好回滚脚本和验证步骤</li></ul>`,32))])}const C=l(o,[["render",g]]);export{B as __pageData,C as default};
