import{_ as h,C as k,c as p,o as t,j as i,b as e,a3 as E,a,w as n,G as d,a4 as r}from"./chunks/framework.CUcrqFol.js";const u=JSON.parse('{"title":"6.5 接入微信/QQ 登录——第三方登录集成深度：微信/QQ/钉钉/企业微信","description":"6.5 接入微信/QQ 登录——第三方登录集成深度 认知重构 国内第三方登录和 Google/GitHub 登录的技术原理完全相同——都是 OAuth 2.0 授权码模式。但实际接入时会遇到很多\\"中国特色\\"： 申请流程复杂，需要企业资质 微信生态碎片化（开放平台 vs 公众号） 钉钉/企微主要面向企业内部应用 文档和","frontmatter":{"title":"6.5 接入微信/QQ 登录——第三方登录集成深度：微信/QQ/钉钉/企业微信","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/06-security/6.5-social-login-china/index.md","filePath":"Advanced-old/06-security/6.5-social-login-china/index.md","lastUpdated":1766168364000}'),g={name:"Advanced-old/06-security/6.5-social-login-china/index.md"};function y(o,s,c,F,A,B){const l=k("Mermaid");return t(),p("div",null,[s[1]||(s[1]=i("h1",{id:"_6-5-接入微信-qq-登录——第三方登录集成深度",tabindex:"-1"},[a("6.5 接入微信/QQ 登录——第三方登录集成深度 "),i("a",{class:"header-anchor",href:"#_6-5-接入微信-qq-登录——第三方登录集成深度","aria-label":'Permalink to "6.5 接入微信/QQ 登录——第三方登录集成深度"'},"​")],-1)),s[2]||(s[2]=i("h2",{id:"认知重构",tabindex:"-1"},[a("认知重构 "),i("a",{class:"header-anchor",href:"#认知重构","aria-label":'Permalink to "认知重构"'},"​")],-1)),s[3]||(s[3]=i("p",null,'国内第三方登录和 Google/GitHub 登录的技术原理完全相同——都是 OAuth 2.0 授权码模式。但实际接入时会遇到很多"中国特色"：',-1)),s[4]||(s[4]=i("ul",null,[i("li",null,"申请流程复杂，需要企业资质"),i("li",null,"微信生态碎片化（开放平台 vs 公众号）"),i("li",null,"钉钉/企微主要面向企业内部应用"),i("li",null,"文档和 SDK 的使用体验参差不齐")],-1)),(t(),e(r,null,{default:n(()=>[d(l,{id:"mermaid-31",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20subgraph%20Platforms%5B%22%E5%9B%BD%E5%86%85%E4%B8%BB%E6%B5%81%E7%99%BB%E5%BD%95%E5%B9%B3%E5%8F%B0%22%5D%0A%20%20%20%20%20%20%20%20WeChat%5B%22%E5%BE%AE%E4%BF%A1%5Cn%E6%89%AB%E7%A0%81%2F%E5%85%AC%E4%BC%97%E5%8F%B7%22%5D%0A%20%20%20%20%20%20%20%20QQ%5B%22QQ%E4%BA%92%E8%81%94%5Cn%E4%B8%AA%E4%BA%BA%E7%94%A8%E6%88%B7%22%5D%0A%20%20%20%20%20%20%20%20DingTalk%5B%22%E9%92%89%E9%92%89%5Cn%E4%BC%81%E4%B8%9A%E5%BA%94%E7%94%A8%22%5D%0A%20%20%20%20%20%20%20%20WeCom%5B%22%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%5Cn%E4%BC%81%E4%B8%9A%E5%86%85%E9%83%A8%22%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20Scenarios%5B%22%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%22%5D%0A%20%20%20%20%20%20%20%20C2C%5B%22C%E7%AB%AF%E4%BA%A7%E5%93%81%22%5D%0A%20%20%20%20%20%20%20%20B2B%5B%22B%E7%AB%AF%E4%BA%A7%E5%93%81%22%5D%0A%20%20%20%20%20%20%20%20Internal%5B%22%E4%BC%81%E4%B8%9A%E5%86%85%E9%83%A8%22%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20WeChat%20--%3E%20C2C%0A%20%20%20%20QQ%20--%3E%20C2C%0A%20%20%20%20DingTalk%20--%3E%20B2B%0A%20%20%20%20DingTalk%20--%3E%20Internal%0A%20%20%20%20WeCom%20--%3E%20Internal%0A"})]),fallback:n(()=>[...s[0]||(s[0]=[a(" Loading... ",-1)])]),_:1})),s[5]||(s[5]=E(`<h2 id="本节内容" tabindex="-1">本节内容 <a class="header-anchor" href="#本节内容" aria-label="Permalink to &quot;本节内容&quot;">​</a></h2><table tabindex="0"><thead><tr><th>小节</th><th>核心问题</th><th>你将学会</th></tr></thead><tbody><tr><td>6.5.1 OAuth 流程</td><td>授权码模式是什么？</td><td>理解第三方登录的通用原理</td></tr><tr><td>6.5.2 微信登录</td><td>微信登录怎么接？</td><td>开放平台与公众号登录</td></tr><tr><td>6.5.3 QQ 登录</td><td>QQ 登录怎么接？</td><td>QQ 互联平台配置</td></tr><tr><td>6.5.4 钉钉登录</td><td>钉钉登录怎么接？</td><td>企业应用与第三方应用</td></tr><tr><td>6.5.5 账号绑定</td><td>多平台账号怎么统一？</td><td>用户账号合并策略</td></tr><tr><td>6.5.6 错误处理</td><td>登录失败怎么办？</td><td>异常情况与用户提示</td></tr></tbody></table><h2 id="平台对比速览" tabindex="-1">平台对比速览 <a class="header-anchor" href="#平台对比速览" aria-label="Permalink to &quot;平台对比速览&quot;">​</a></h2><table tabindex="0"><thead><tr><th>平台</th><th>申请难度</th><th>适用场景</th><th>是否需要企业资质</th></tr></thead><tbody><tr><td>微信开放平台</td><td>高</td><td>C 端产品</td><td>是</td></tr><tr><td>微信公众号</td><td>中</td><td>H5/公众号内</td><td>是（服务号）</td></tr><tr><td>QQ 互联</td><td>中</td><td>C 端产品</td><td>否（但需审核）</td></tr><tr><td>钉钉</td><td>低</td><td>B 端/企业内</td><td>企业入驻即可</td></tr><tr><td>企业微信</td><td>低</td><td>企业内部</td><td>企业入驻即可</td></tr></tbody></table><h2 id="通用开发模式" tabindex="-1">通用开发模式 <a class="header-anchor" href="#通用开发模式" aria-label="Permalink to &quot;通用开发模式&quot;">​</a></h2><p>无论接入哪个平台，代码结构都类似：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. 生成授权 URL，重定向用户</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> authUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buildAuthUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    client_id: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PLATFORM_CLIENT_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    redirect_uri: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://your-site.com/api/auth/callback&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">generateState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 防 CSRF</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scope: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user_info&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(authUrl)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2. 接收回调，换取 access_token</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getSearchParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 验证 state</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">verifyState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(state)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/login?error=invalid_state&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 用 code 换 token</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tokenResponse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TOKEN_URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    body: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> URLSearchParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      code,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      client_id: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLIENT_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      client_secret: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLIENT_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">access_token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tokenResponse.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. 用 token 获取用户信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userInfo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchUserInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(access_token)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4. 创建或关联本地用户</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findOrCreateUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userInfo)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 5. 创建会话</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/dashboard&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="ai-协作提示" tabindex="-1">AI 协作提示 <a class="header-anchor" href="#ai-协作提示" aria-label="Permalink to &quot;AI 协作提示&quot;">​</a></h2><p>向 AI 描述国内第三方登录需求时：</p><ul><li>&quot;实现微信扫码登录，使用 OAuth 2.0 授权码模式&quot;</li><li>&quot;在服务端存储 state 防止 CSRF 攻击&quot;</li><li>&quot;处理用户首次登录和账号绑定的逻辑&quot;</li><li>&quot;添加登录失败的错误处理和用户提示&quot;</li></ul><div class="warning custom-block"><p class="custom-block-title">国内登录接入清单</p><ol><li>[ ] 准备好企业资质材料</li><li>[ ] 在各平台完成应用注册</li><li>[ ] 配置正确的回调地址</li><li>[ ] 实现 state 参数防 CSRF</li><li>[ ] 处理多平台账号绑定逻辑</li><li>[ ] 完善错误提示和异常处理</li></ol></div>`,11))])}const D=h(g,[["render",y]]);export{u as __pageData,D as default};
