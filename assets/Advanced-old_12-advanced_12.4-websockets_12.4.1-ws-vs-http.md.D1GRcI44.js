import{_ as n,C as l,c as p,o as a,a3 as i,b as h,w as t,a as k,G as d,a4 as r}from"./chunks/framework.CUcrqFol.js";const y=JSON.parse('{"title":"12.4.1 为什么需要实时通信——WebSocket vs HTTP：长连接的优势","description":"12.4.1 为什么需要实时通信——WebSocket vs HTTP：长连接的优势 一句话破题 HTTP 是\\"你问我答\\"，WebSocket 是\\"保持通话\\"——后者让服务器能在任何时候主动给你发消息。 本质还原：两种通信模式 HTTP 轮询的问题 问题： **浪费资源**：大多数请求返回\\"没有新消息\\" **延迟高**","frontmatter":{"title":"12.4.1 为什么需要实时通信——WebSocket vs HTTP：长连接的优势","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/12-advanced/12.4-websockets/12.4.1-ws-vs-http.md","filePath":"Advanced-old/12-advanced/12.4-websockets/12.4.1-ws-vs-http.md","lastUpdated":1766168364000}'),E={name:"Advanced-old/12-advanced/12.4-websockets/12.4.1-ws-vs-http.md"};function o(c,s,g,A,b,F){const e=l("Mermaid");return a(),p("div",null,[s[1]||(s[1]=i('<h1 id="_12-4-1-为什么需要实时通信——websocket-vs-http-长连接的优势" tabindex="-1">12.4.1 为什么需要实时通信——WebSocket vs HTTP：长连接的优势 <a class="header-anchor" href="#_12-4-1-为什么需要实时通信——websocket-vs-http-长连接的优势" aria-label="Permalink to &quot;12.4.1 为什么需要实时通信——WebSocket vs HTTP：长连接的优势&quot;">​</a></h1><h3 id="一句话破题" tabindex="-1">一句话破题 <a class="header-anchor" href="#一句话破题" aria-label="Permalink to &quot;一句话破题&quot;">​</a></h3><p>HTTP 是&quot;你问我答&quot;，WebSocket 是&quot;保持通话&quot;——后者让服务器能在任何时候主动给你发消息。</p><h3 id="本质还原-两种通信模式" tabindex="-1">本质还原：两种通信模式 <a class="header-anchor" href="#本质还原-两种通信模式" aria-label="Permalink to &quot;本质还原：两种通信模式&quot;">​</a></h3>',4)),(a(),h(r,null,{default:t(()=>[d(e,{id:"mermaid-12",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20C%20as%20%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%20%20%20%20participant%20S%20as%20%E6%9C%8D%E5%8A%A1%E5%99%A8%0A%20%20%20%20%0A%20%20%20%20rect%20rgb(255%2C%20230%2C%20230)%0A%20%20%20%20%20%20%20%20Note%20over%20C%2CS%3A%20HTTP%EF%BC%88%E8%BD%AE%E8%AF%A2%EF%BC%89%0A%20%20%20%20%20%20%20%20C-%3E%3ES%3A%20%E6%9C%89%E6%96%B0%E6%B6%88%E6%81%AF%E5%90%97%EF%BC%9F%0A%20%20%20%20%20%20%20%20S-%3E%3EC%3A%20%E6%B2%A1%E6%9C%89%0A%20%20%20%20%20%20%20%20C-%3E%3ES%3A%20%E6%9C%89%E6%96%B0%E6%B6%88%E6%81%AF%E5%90%97%EF%BC%9F%0A%20%20%20%20%20%20%20%20S-%3E%3EC%3A%20%E6%B2%A1%E6%9C%89%0A%20%20%20%20%20%20%20%20C-%3E%3ES%3A%20%E6%9C%89%E6%96%B0%E6%B6%88%E6%81%AF%E5%90%97%EF%BC%9F%0A%20%20%20%20%20%20%20%20S-%3E%3EC%3A%20%E6%9C%89%EF%BC%81%E8%BF%99%E6%98%AF%E6%B6%88%E6%81%AF%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20rect%20rgb(230%2C%20255%2C%20230)%0A%20%20%20%20%20%20%20%20Note%20over%20C%2CS%3A%20WebSocket%0A%20%20%20%20%20%20%20%20C-%3E%3ES%3A%20%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%EF%BC%88%E6%8F%A1%E6%89%8B%EF%BC%89%0A%20%20%20%20%20%20%20%20S-%3E%3EC%3A%20%E8%BF%9E%E6%8E%A5%E5%B7%B2%E5%BB%BA%E7%AB%8B%0A%20%20%20%20%20%20%20%20Note%20over%20C%2CS%3A%20%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1%E9%80%9A%E9%81%93%E5%BC%80%E5%90%AF%0A%20%20%20%20%20%20%20%20S--%3E%3EC%3A%20%E6%96%B0%E6%B6%88%E6%81%AF%E6%9D%A5%E4%BA%86%EF%BC%81%0A%20%20%20%20%20%20%20%20C--%3E%3ES%3A%20%E5%A5%BD%E7%9A%84%EF%BC%8C%E6%94%B6%E5%88%B0%0A%20%20%20%20%20%20%20%20S--%3E%3EC%3A%20%E5%8F%88%E6%9C%89%E6%96%B0%E6%B6%88%E6%81%AF%EF%BC%81%0A%20%20%20%20end%0A"})]),fallback:t(()=>[...s[0]||(s[0]=[k(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=i(`<h3 id="http-轮询的问题" tabindex="-1">HTTP 轮询的问题 <a class="header-anchor" href="#http-轮询的问题" aria-label="Permalink to &quot;HTTP 轮询的问题&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 轮询：每秒询问一次有没有新消息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/messages&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> messages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  updateUI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(messages);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>问题：</p><ul><li><strong>浪费资源</strong>：大多数请求返回&quot;没有新消息&quot;</li><li><strong>延迟高</strong>：最坏情况下延迟 = 轮询间隔</li><li><strong>服务器压力</strong>：1000 用户 × 每秒 1 次 = 1000 QPS</li></ul><h3 id="websocket-的优势" tabindex="-1">WebSocket 的优势 <a class="header-anchor" href="#websocket-的优势" aria-label="Permalink to &quot;WebSocket 的优势&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WebSocket：建立一次连接，持续接收消息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;wss://example.com/socket&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onmessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event.data);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  updateUI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 发送消息也很简单</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ text: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Hello!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }));</span></span></code></pre></div><table tabindex="0"><thead><tr><th>特性</th><th>HTTP 轮询</th><th>WebSocket</th></tr></thead><tbody><tr><td>连接方式</td><td>每次请求新连接</td><td>持久连接</td></tr><tr><td>通信方向</td><td>单向（客户端发起）</td><td>双向</td></tr><tr><td>实时性</td><td>取决于轮询间隔</td><td>毫秒级</td></tr><tr><td>资源消耗</td><td>高</td><td>低</td></tr><tr><td>服务器推送</td><td>不支持</td><td>原生支持</td></tr></tbody></table><h3 id="websocket-握手过程" tabindex="-1">WebSocket 握手过程 <a class="header-anchor" href="#websocket-握手过程" aria-label="Permalink to &quot;WebSocket 握手过程&quot;">​</a></h3><p>WebSocket 连接从 HTTP 升级开始：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>// 客户端请求</span></span>
<span class="line"><span>GET /socket HTTP/1.1</span></span>
<span class="line"><span>Host: example.com</span></span>
<span class="line"><span>Upgrade: websocket</span></span>
<span class="line"><span>Connection: Upgrade</span></span>
<span class="line"><span>Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span></span>
<span class="line"><span>Sec-WebSocket-Version: 13</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 服务器响应</span></span>
<span class="line"><span>HTTP/1.1 101 Switching Protocols</span></span>
<span class="line"><span>Upgrade: websocket</span></span>
<span class="line"><span>Connection: Upgrade</span></span>
<span class="line"><span>Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span></span></code></pre></div><p>握手完成后，连接从 HTTP 升级为 WebSocket，双方可以自由发送数据帧。</p><h3 id="何时使用-websocket" tabindex="-1">何时使用 WebSocket <a class="header-anchor" href="#何时使用-websocket" aria-label="Permalink to &quot;何时使用 WebSocket&quot;">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>即时通讯、聊天</td><td>WebSocket</td></tr><tr><td>实时协作编辑</td><td>WebSocket</td></tr><tr><td>股票行情、体育比分</td><td>WebSocket / SSE</td></tr><tr><td>表单提交、API 调用</td><td>HTTP</td></tr><tr><td>文件下载</td><td>HTTP</td></tr><tr><td>偶尔获取数据（间隔 &gt; 30s）</td><td>HTTP</td></tr></tbody></table><h3 id="ai-协作指南" tabindex="-1">AI 协作指南 <a class="header-anchor" href="#ai-协作指南" aria-label="Permalink to &quot;AI 协作指南&quot;">​</a></h3><ul><li><strong>核心意图</strong>：让 AI 帮你理解何时以及如何使用 WebSocket。</li><li><strong>需求定义公式</strong>：<code>&quot;请解释 WebSocket 和 HTTP 长轮询的区别，并说明在什么场景下应该选择哪种方案。&quot;</code></li><li><strong>关键术语</strong>：<code>WebSocket</code>、<code>握手 (handshake)</code>、<code>全双工 (full-duplex)</code>、<code>持久连接 (persistent connection)</code></li></ul><h3 id="避坑指南" tabindex="-1">避坑指南 <a class="header-anchor" href="#避坑指南" aria-label="Permalink to &quot;避坑指南&quot;">​</a></h3><ul><li><strong>不要为所有场景都用 WebSocket</strong>：简单的 CRUD 操作用 HTTP 更合适。</li><li><strong>注意连接限制</strong>：浏览器对单个域名的 WebSocket 连接数有限制。</li><li><strong>考虑负载均衡</strong>：WebSocket 的长连接对负载均衡有特殊要求（需要 sticky session）。</li></ul>`,17))])}const B=n(E,[["render",o]]);export{y as __pageData,B as default};
