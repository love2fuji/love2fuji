import{_ as r,C as d,c as E,o as a,a3 as l,b as p,j as h,w as i,a as n,G as k,a4 as e}from"./chunks/framework.CUcrqFol.js";const C=JSON.parse('{"title":"4.2.5 张三为什么看不了李四的数据——行级安全 ：PostgreSQL 核心安全特性","description":"4.2.5 张三为什么看不了李四的数据——行级安全 ：PostgreSQL 核心安全特性 一句话破题 行级安全（RLS）让数据库自动过滤数据——用户只能看到属于自己的记录，无需在每个查询中手动添加 WHERE 条件。 为什么需要 RLS？ **传统做法**：每个查询都要手动添加用户过滤 **问题**： 开发者可能忘记添","frontmatter":{"title":"4.2.5 张三为什么看不了李四的数据——行级安全 ：PostgreSQL 核心安全特性","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/04-database/4.2-rdbms-basics/4.2.5-rls.md","filePath":"Advanced-old/04-database/4.2-rdbms-basics/4.2.5-rls.md","lastUpdated":1766168364000}'),g={name:"Advanced-old/04-database/4.2-rdbms-basics/4.2.5-rls.md"};function o(y,s,c,F,A,u){const t=d("Mermaid");return a(),E("div",null,[s[2]||(s[2]=l(`<h1 id="_4-2-5-张三为什么看不了李四的数据——行级安全-postgresql-核心安全特性" tabindex="-1">4.2.5 张三为什么看不了李四的数据——行级安全 ：PostgreSQL 核心安全特性 <a class="header-anchor" href="#_4-2-5-张三为什么看不了李四的数据——行级安全-postgresql-核心安全特性" aria-label="Permalink to &quot;4.2.5 张三为什么看不了李四的数据——行级安全 ：PostgreSQL 核心安全特性&quot;">​</a></h1><h3 id="一句话破题" tabindex="-1">一句话破题 <a class="header-anchor" href="#一句话破题" aria-label="Permalink to &quot;一句话破题&quot;">​</a></h3><p>行级安全（RLS）让数据库自动过滤数据——用户只能看到属于自己的记录，无需在每个查询中手动添加 WHERE 条件。</p><h3 id="为什么需要-rls" tabindex="-1">为什么需要 RLS？ <a class="header-anchor" href="#为什么需要-rls" aria-label="Permalink to &quot;为什么需要 RLS？&quot;">​</a></h3><p><strong>传统做法</strong>：每个查询都要手动添加用户过滤</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 每次查询都要记得加 userId 条件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> posts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prisma.post.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findMany</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  where: { userId: currentUserId }  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 容易忘记！</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p><strong>问题</strong>：</p><ul><li>开发者可能忘记添加过滤条件</li><li>一旦遗漏，用户就能看到其他人的数据</li><li>安全隐患巨大</li></ul><p><strong>RLS 解决方案</strong>：数据库层面自动过滤</p>`,9)),(a(),p(e,null,{default:i(()=>[k(t,{id:"mermaid-39",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%22%E5%BA%94%E7%94%A8%E6%9F%A5%E8%AF%A2%22%5D%20--%3E%20B%5B%22%E6%95%B0%E6%8D%AE%E5%BA%93%22%5D%0A%20%20%20%20B%20--%3E%20C%5B%22RLS%20%E7%AD%96%E7%95%A5%E8%87%AA%E5%8A%A8%E8%BF%87%E6%BB%A4%22%5D%0A%20%20%20%20C%20--%3E%20D%5B%22%E5%8F%AA%E8%BF%94%E5%9B%9E%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E7%9A%84%E6%95%B0%E6%8D%AE%22%5D%0A"})]),fallback:i(()=>[...s[0]||(s[0]=[n(" Loading... ",-1)])]),_:1})),s[3]||(s[3]=h("h3",{id:"rls-的工作原理",tabindex:"-1"},[n("RLS 的工作原理 "),h("a",{class:"header-anchor",href:"#rls-的工作原理","aria-label":'Permalink to "RLS 的工作原理"'},"​")],-1)),(a(),p(e,null,{default:i(()=>[k(t,{id:"mermaid-43",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20App%20as%20%E5%BA%94%E7%94%A8%0A%20%20%20%20participant%20DB%20as%20PostgreSQL%0A%20%20%20%20participant%20RLS%20as%20RLS%20%E7%AD%96%E7%95%A5%0A%20%20%20%20%0A%20%20%20%20App-%3E%3EDB%3A%20SELECT%20*%20FROM%20posts%0A%20%20%20%20DB-%3E%3ERLS%3A%20%E6%A3%80%E6%9F%A5%20RLS%20%E7%AD%96%E7%95%A5%0A%20%20%20%20RLS-%3E%3ERLS%3A%20current_user_id%20%3D%20post.user_id%20%3F%0A%20%20%20%20RLS--%3E%3EDB%3A%20%E8%BF%87%E6%BB%A4%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C%0A%20%20%20%20DB--%3E%3EApp%3A%20%E5%8F%AA%E8%BF%94%E5%9B%9E%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E7%9A%84%20posts%0A"})]),fallback:i(()=>[...s[1]||(s[1]=[n(" Loading... ",-1)])]),_:1})),s[4]||(s[4]=l(`<h3 id="在-supabase-中使用-rls" tabindex="-1">在 Supabase 中使用 RLS <a class="header-anchor" href="#在-supabase-中使用-rls" aria-label="Permalink to &quot;在 Supabase 中使用 RLS&quot;">​</a></h3><p>Supabase 内置了 RLS 支持，这也是本课程推荐使用 Supabase 的原因之一。</p><p><strong>步骤一：启用 RLS</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 对表启用 RLS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> posts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENABLE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ROW</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SECURITY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><strong>步骤二：创建策略</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 用户只能查看自己的文章</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Users can view own posts&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> posts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SELECT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 用户只能创建属于自己的文章</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Users can create own posts&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> posts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> INSERT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WITH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> CHECK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 用户只能更新自己的文章</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Users can update own posts&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> posts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> UPDATE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 用户只能删除自己的文章</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Users can delete own posts&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> posts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> DELETE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><h3 id="常见-rls-策略模式" tabindex="-1">常见 RLS 策略模式 <a class="header-anchor" href="#常见-rls-策略模式" aria-label="Permalink to &quot;常见 RLS 策略模式&quot;">​</a></h3><p><strong>模式一：用户隔离</strong></p><p>每个用户只能访问自己的数据：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;User isolation&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><p><strong>模式二：公开 + 私有</strong></p><p>公开数据所有人可见，私有数据仅作者可见：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Public or own posts&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> posts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SELECT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_public </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> true </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  OR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>模式三：组织/团队隔离</strong></p><p>同一组织的成员可以互相访问：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Team access&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> documents </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SELECT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  team_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> team_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> team_members </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>模式四：角色权限</strong></p><p>管理员可以访问所有数据：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> POLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Admin full access&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> posts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ALL</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">jwt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;role&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;admin&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  OR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="prisma-supabase-配合使用" tabindex="-1">Prisma + Supabase 配合使用 <a class="header-anchor" href="#prisma-supabase-配合使用" aria-label="Permalink to &quot;Prisma + Supabase 配合使用&quot;">​</a></h3><p>虽然 Prisma 不直接支持 RLS，但可以配合 Supabase 使用：</p><p><strong>方案一：使用 Supabase Client 直接查询</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { createClient } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@supabase/supabase-js&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> supabase</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url, anonKey)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// RLS 会自动生效</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> supabase</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;posts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;*&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动过滤，只返回当前用户的数据</span></span></code></pre></div><p><strong>方案二：Prisma + 手动过滤（非敏感数据）</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 对于非核心安全数据，可以在应用层过滤</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> posts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prisma.post.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findMany</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  where: { userId: session.user.id }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h3 id="rls-vs-应用层过滤" tabindex="-1">RLS vs 应用层过滤 <a class="header-anchor" href="#rls-vs-应用层过滤" aria-label="Permalink to &quot;RLS vs 应用层过滤&quot;">​</a></h3><table tabindex="0"><thead><tr><th>特性</th><th>RLS</th><th>应用层过滤</th></tr></thead><tbody><tr><td><strong>安全性</strong></td><td>数据库层面强制执行</td><td>依赖开发者不遗漏</td></tr><tr><td><strong>性能</strong></td><td>数据库优化</td><td>可能多查数据再过滤</td></tr><tr><td><strong>复杂度</strong></td><td>需要学习 SQL 策略</td><td>简单直观</td></tr><tr><td><strong>灵活性</strong></td><td>策略固定</td><td>可动态调整</td></tr></tbody></table><p><strong>建议</strong>：</p><ul><li>敏感数据（用户隐私、财务数据）→ 使用 RLS</li><li>一般数据 → 应用层过滤即可</li></ul><h3 id="避坑指南" tabindex="-1">避坑指南 <a class="header-anchor" href="#避坑指南" aria-label="Permalink to &quot;避坑指南&quot;">​</a></h3><ol><li><p><strong>忘记启用 RLS</strong>：创建表后记得执行 <code>ALTER TABLE ... ENABLE ROW LEVEL SECURITY</code></p></li><li><p><strong>策略过于严格</strong>：如果没有创建任何策略，启用 RLS 后所有查询都会返回空</p></li><li><p><strong>服务端绕过 RLS</strong>：使用 service_role key 会绕过 RLS，只在后端使用</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 后端管理操作，绕过 RLS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> adminClient</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url, serviceRoleKey)</span></span></code></pre></div></li><li><p><strong>性能考虑</strong>：复杂的 RLS 策略可能影响查询性能，注意优化</p></li></ol><h3 id="本节小结" tabindex="-1">本节小结 <a class="header-anchor" href="#本节小结" aria-label="Permalink to &quot;本节小结&quot;">​</a></h3><ul><li>RLS 让数据库自动过滤数据，防止数据泄露</li><li>Supabase 内置 RLS 支持，配置简单</li><li>常见策略：用户隔离、公开/私有、团队访问、角色权限</li><li>敏感数据建议使用 RLS，一般数据可用应用层过滤</li></ul>`,33))])}const b=r(g,[["render",o]]);export{C as __pageData,b as default};
