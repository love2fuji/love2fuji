import{_ as e,C as l,c as h,o as i,a3 as a,b as p,w as t,a as d,G as k,a4 as r}from"./chunks/framework.CUcrqFol.js";const C=JSON.parse('{"title":"4.2.2 为什么查询这么快——索引原理：B-Tree 索引与查询优化","description":"4.2.2 为什么查询这么快——索引原理：B-Tree 索引与查询优化 一句话破题 索引就像书的目录——没有它你只能一页页翻找，有了它可以直接跳到目标位置。 索引的本质 | 数据量 | 全表扫描 | 索引查询 | |--------|----------|----------| | 1,000 | 1,000 次 |","frontmatter":{"title":"4.2.2 为什么查询这么快——索引原理：B-Tree 索引与查询优化","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/04-database/4.2-rdbms-basics/4.2.2-indexes.md","filePath":"Advanced-old/04-database/4.2-rdbms-basics/4.2.2-indexes.md","lastUpdated":1766168364000}'),E={name:"Advanced-old/04-database/4.2-rdbms-basics/4.2.2-indexes.md"};function o(g,s,c,y,u,F){const n=l("Mermaid");return i(),h("div",null,[s[1]||(s[1]=a('<h1 id="_4-2-2-为什么查询这么快——索引原理-b-tree-索引与查询优化" tabindex="-1">4.2.2 为什么查询这么快——索引原理：B-Tree 索引与查询优化 <a class="header-anchor" href="#_4-2-2-为什么查询这么快——索引原理-b-tree-索引与查询优化" aria-label="Permalink to &quot;4.2.2 为什么查询这么快——索引原理：B-Tree 索引与查询优化&quot;">​</a></h1><h3 id="一句话破题" tabindex="-1">一句话破题 <a class="header-anchor" href="#一句话破题" aria-label="Permalink to &quot;一句话破题&quot;">​</a></h3><p>索引就像书的目录——没有它你只能一页页翻找，有了它可以直接跳到目标位置。</p><h3 id="索引的本质" tabindex="-1">索引的本质 <a class="header-anchor" href="#索引的本质" aria-label="Permalink to &quot;索引的本质&quot;">​</a></h3>',4)),(i(),p(r,null,{default:t(()=>[k(n,{id:"mermaid-12",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%22%E6%97%A0%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2%22%5D%20--%3E%20B%5B%22%E5%85%A8%E8%A1%A8%E6%89%AB%E6%8F%8F%22%5D%0A%20%20%20%20B%20--%3E%20C%5B%22O(n)%20%E7%BA%BF%E6%80%A7%E5%A4%8D%E6%9D%82%E5%BA%A6%22%5D%0A%20%20%20%20%0A%20%20%20%20D%5B%22%E6%9C%89%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2%22%5D%20--%3E%20E%5B%22B-Tree%20%E6%9F%A5%E6%89%BE%22%5D%0A%20%20%20%20E%20--%3E%20F%5B%22O(log%20n)%20%E5%AF%B9%E6%95%B0%E5%A4%8D%E6%9D%82%E5%BA%A6%22%5D%0A"})]),fallback:t(()=>[...s[0]||(s[0]=[d(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=a(`<table tabindex="0"><thead><tr><th>数据量</th><th>全表扫描</th><th>索引查询</th></tr></thead><tbody><tr><td>1,000</td><td>1,000 次</td><td>10 次</td></tr><tr><td>100,000</td><td>100,000 次</td><td>17 次</td></tr><tr><td>10,000,000</td><td>10,000,000 次</td><td>24 次</td></tr></tbody></table><h3 id="b-tree-索引的工作原理" tabindex="-1">B-Tree 索引的工作原理 <a class="header-anchor" href="#b-tree-索引的工作原理" aria-label="Permalink to &quot;B-Tree 索引的工作原理&quot;">​</a></h3><p>B-Tree（平衡树）是数据库最常用的索引结构：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>              [50]</span></span>
<span class="line"><span>             /    \\</span></span>
<span class="line"><span>        [25,35]    [75,85]</span></span>
<span class="line"><span>        / | \\       / | \\</span></span>
<span class="line"><span>    [10] [30] [40] [60] [80] [90]</span></span></code></pre></div><ul><li>每个节点包含多个键值</li><li>数据按顺序排列</li><li>从根节点开始，每次排除一半数据</li></ul><h3 id="在-prisma-中创建索引" tabindex="-1">在 Prisma 中创建索引 <a class="header-anchor" href="#在-prisma-中创建索引" aria-label="Permalink to &quot;在 Prisma 中创建索引&quot;">​</a></h3><p><strong>单字段索引</strong>：</p><div class="language-prisma vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">prisma</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">model</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">String</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> @id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  email </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">String</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> @unique</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 唯一索引，自动创建</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">String</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  @@index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 普通索引</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>复合索引</strong>：</p><div class="language-prisma vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">prisma</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">model</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id        </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">String</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> @id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  authorId  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">String</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  status    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">String</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  createdAt </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DateTime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 复合索引：authorId + status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  @@index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">authorId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>何时需要创建索引</strong>：</p><table tabindex="0"><thead><tr><th>场景</th><th>是否需要索引</th></tr></thead><tbody><tr><td>WHERE 条件字段</td><td>需要</td></tr><tr><td>ORDER BY 排序字段</td><td>需要</td></tr><tr><td>JOIN 关联字段</td><td>需要（外键自动创建）</td></tr><tr><td>唯一约束字段</td><td>自动创建</td></tr><tr><td>很少查询的字段</td><td>不需要</td></tr></tbody></table><h3 id="复合索引的顺序" tabindex="-1">复合索引的顺序 <a class="header-anchor" href="#复合索引的顺序" aria-label="Permalink to &quot;复合索引的顺序&quot;">​</a></h3><p>复合索引的字段顺序很重要，遵循<strong>最左前缀原则</strong>：</p><div class="language-prisma vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">prisma</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@@index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">authorId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">createdAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><ul><li>✅ 支持 <code>WHERE authorId = ?</code></li><li>✅ 支持 <code>WHERE authorId = ? AND status = ?</code></li><li>✅ 支持 <code>WHERE authorId = ? AND status = ? AND createdAt &gt; ?</code></li><li>❌ 不支持 <code>WHERE status = ?</code>（跳过了 authorId）</li><li>❌ 不支持 <code>WHERE createdAt &gt; ?</code>（跳过了前两个字段）</li></ul><h3 id="索引的代价" tabindex="-1">索引的代价 <a class="header-anchor" href="#索引的代价" aria-label="Permalink to &quot;索引的代价&quot;">​</a></h3><p>索引不是免费的：</p><table tabindex="0"><thead><tr><th>获得</th><th>付出</th></tr></thead><tbody><tr><td>查询变快</td><td>写入变慢（需要维护索引）</td></tr><tr><td>范围查询高效</td><td>占用额外存储空间</td></tr><tr><td>-</td><td>索引过多会影响写入性能</td></tr></tbody></table><h3 id="查询优化实践" tabindex="-1">查询优化实践 <a class="header-anchor" href="#查询优化实践" aria-label="Permalink to &quot;查询优化实践&quot;">​</a></h3><p><strong>查看查询执行计划</strong>（PostgreSQL）：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXPLAIN ANALYZE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;test@example.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><strong>Prisma 日志查看生成的 SQL</strong>：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> prisma</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PrismaClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  log: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;query&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p><strong>常见优化技巧</strong>：</p><ol><li><p><strong>只查询需要的字段</strong>：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 只选择需要的字段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prisma.user.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findMany</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  select: { id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div></li><li><p>**避免 SELECT ***：不要查询不需要的大字段</p></li><li><p><strong>合理使用分页</strong>：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prisma.user.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findMany</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  take: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  skip: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div></li></ol><h3 id="什么时候不用索引" tabindex="-1">什么时候不用索引 <a class="header-anchor" href="#什么时候不用索引" aria-label="Permalink to &quot;什么时候不用索引&quot;">​</a></h3><p>即使有索引，数据库也可能选择不使用：</p><ul><li>查询结果超过表数据的 20-30%</li><li>使用了函数计算（如 <code>LOWER(email)</code>）</li><li>使用了 <code>LIKE &#39;%keyword&#39;</code>（前缀通配符）</li></ul><h3 id="避坑指南" tabindex="-1">避坑指南 <a class="header-anchor" href="#避坑指南" aria-label="Permalink to &quot;避坑指南&quot;">​</a></h3><ol><li><p><strong>不要给每个字段都加索引</strong>：只给查询条件中的高频字段加</p></li><li><p><strong>注意索引失效场景</strong>：</p><ul><li>对索引列使用函数</li><li>隐式类型转换</li><li>LIKE 以通配符开头</li></ul></li><li><p><strong>定期检查慢查询</strong>：监控并优化慢 SQL</p></li></ol><h3 id="本节小结" tabindex="-1">本节小结 <a class="header-anchor" href="#本节小结" aria-label="Permalink to &quot;本节小结&quot;">​</a></h3><ul><li>索引通过 B-Tree 结构加速查询</li><li>外键和唯一约束会自动创建索引</li><li>复合索引遵循最左前缀原则</li><li>索引有代价，不是越多越好</li></ul>`,33))])}const m=e(E,[["render",o]]);export{C as __pageData,m as default};
