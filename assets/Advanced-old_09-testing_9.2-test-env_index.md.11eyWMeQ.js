import{_ as p,C as l,c as d,o as n,j as a,b as h,a3 as r,a as t,w as e,G as o,a4 as E}from"./chunks/framework.CUcrqFol.js";const y=JSON.parse('{"title":"9.2 在沙盒里跑测试——测试环境与隔离：.env.test、迁移、数据清理","description":"9.2 在沙盒里跑测试——测试环境与隔离： 、迁移、数据清理 **测试环境的核心原则：与生产完全隔离，每次测试都从干净状态开始。** 为什么需要独立的测试环境 测试环境隔离的必要性： | 风险 | 后果 | 解决方案 | |------|------|---------| | 测试数据写入生产库 | 用户看到测试数据","frontmatter":{"title":"9.2 在沙盒里跑测试——测试环境与隔离：`.env.test`、迁移、数据清理","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/09-testing/9.2-test-env/index.md","filePath":"Advanced-old/09-testing/9.2-test-env/index.md","lastUpdated":1766168364000}'),k={name:"Advanced-old/09-testing/9.2-test-env/index.md"};function c(A,s,g,u,B,b){const i=l("Mermaid");return n(),d("div",null,[s[1]||(s[1]=a("h1",{id:"_9-2-在沙盒里跑测试——测试环境与隔离-env-test、迁移、数据清理",tabindex:"-1"},[t("9.2 在沙盒里跑测试——测试环境与隔离："),a("code",null,".env.test"),t("、迁移、数据清理 "),a("a",{class:"header-anchor",href:"#_9-2-在沙盒里跑测试——测试环境与隔离-env-test、迁移、数据清理","aria-label":'Permalink to "9.2 在沙盒里跑测试——测试环境与隔离：`.env.test`、迁移、数据清理"'},"​")],-1)),s[2]||(s[2]=a("p",null,[a("strong",null,"测试环境的核心原则：与生产完全隔离，每次测试都从干净状态开始。")],-1)),s[3]||(s[3]=a("h2",{id:"为什么需要独立的测试环境",tabindex:"-1"},[t("为什么需要独立的测试环境 "),a("a",{class:"header-anchor",href:"#为什么需要独立的测试环境","aria-label":'Permalink to "为什么需要独立的测试环境"'},"​")],-1)),(n(),h(E,null,{default:e(()=>[o(i,{id:"mermaid-9",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20%E9%94%99%E8%AF%AF%E5%81%9A%E6%B3%95%0A%20%20%20%20%20%20%20%20TEST1%5B%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%5D%20--%3E%20PROD_DB%5B(%E7%94%9F%E4%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93)%5D%0A%20%20%20%20%20%20%20%20PROD_DB%20--%3E%20DISASTER%5B%E6%95%B0%E6%8D%AE%E8%A2%AB%E6%B1%A1%E6%9F%93%2F%E5%88%A0%E9%99%A4%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%E6%AD%A3%E7%A1%AE%E5%81%9A%E6%B3%95%0A%20%20%20%20%20%20%20%20TEST2%5B%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%5D%20--%3E%20TEST_DB%5B(%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E5%BA%93)%5D%0A%20%20%20%20%20%20%20%20PROD%5B%E7%94%9F%E4%BA%A7%E4%BB%A3%E7%A0%81%5D%20--%3E%20PROD_DB2%5B(%E7%94%9F%E4%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93)%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20style%20DISASTER%20fill%3A%23ff6b6b%0A%20%20%20%20style%20TEST_DB%20fill%3A%236bcb77%0A"})]),fallback:e(()=>[...s[0]||(s[0]=[t(" Loading... ",-1)])]),_:1})),s[4]||(s[4]=r(`<p>测试环境隔离的必要性：</p><table tabindex="0"><thead><tr><th>风险</th><th>后果</th><th>解决方案</th></tr></thead><tbody><tr><td>测试数据写入生产库</td><td>用户看到测试数据</td><td>独立数据库</td></tr><tr><td>测试清理生产数据</td><td>数据丢失</td><td>环境变量隔离</td></tr><tr><td>测试影响生产性能</td><td>服务变慢</td><td>独立服务实例</td></tr><tr><td>并行测试数据冲突</td><td>测试不稳定</td><td>事务回滚</td></tr></tbody></table><h2 id="测试环境架构" tabindex="-1">测试环境架构 <a class="header-anchor" href="#测试环境架构" aria-label="Permalink to &quot;测试环境架构&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                  测试环境架构                         │</span></span>
<span class="line"><span>├─────────────────────────────────────────────────────┤</span></span>
<span class="line"><span>│                                                     │</span></span>
<span class="line"><span>│  ┌──────────┐    ┌──────────┐    ┌──────────┐      │</span></span>
<span class="line"><span>│  │ .env.test │    │ test DB  │    │ mock API │      │</span></span>
<span class="line"><span>│  └─────┬────┘    └─────┬────┘    └─────┬────┘      │</span></span>
<span class="line"><span>│        │               │               │           │</span></span>
<span class="line"><span>│        └───────────────┼───────────────┘           │</span></span>
<span class="line"><span>│                        │                           │</span></span>
<span class="line"><span>│                 ┌──────▼──────┐                    │</span></span>
<span class="line"><span>│                 │  测试运行器   │                    │</span></span>
<span class="line"><span>│                 │    Jest     │                    │</span></span>
<span class="line"><span>│                 └─────────────┘                    │</span></span>
<span class="line"><span>│                                                     │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────┘</span></span></code></pre></div><h2 id="本节核心内容" tabindex="-1">本节核心内容 <a class="header-anchor" href="#本节核心内容" aria-label="Permalink to &quot;本节核心内容&quot;">​</a></h2><table tabindex="0"><thead><tr><th>小节</th><th>主题</th><th>解决的问题</th></tr></thead><tbody><tr><td>9.2.1</td><td>环境隔离</td><td>如何配置独立的测试数据库和服务</td></tr><tr><td>9.2.2</td><td>环境变量</td><td>如何管理测试专用配置</td></tr><tr><td>9.2.3</td><td>数据库迁移</td><td>如何初始化测试数据库结构</td></tr><tr><td>9.2.4</td><td>数据清理</td><td>如何确保测试间的状态隔离</td></tr></tbody></table><h2 id="快速入门-最小测试环境配置" tabindex="-1">快速入门：最小测试环境配置 <a class="header-anchor" href="#快速入门-最小测试环境配置" aria-label="Permalink to &quot;快速入门：最小测试环境配置&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 创建测试环境配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">touch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .env.test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 配置测试数据库连接</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;DATABASE_URL=&quot;postgresql://user:pass@localhost:5432/myapp_test&quot;&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .env.test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 在 package.json 中添加测试脚本</span></span></code></pre></div><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;scripts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dotenv -e .env.test -- jest&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;test:setup&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dotenv -e .env.test -- prisma migrate deploy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;test:reset&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dotenv -e .env.test -- prisma migrate reset --force&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="本节小结" tabindex="-1">本节小结 <a class="header-anchor" href="#本节小结" aria-label="Permalink to &quot;本节小结&quot;">​</a></h2><p>测试环境隔离是质量保障的基础设施。通过独立的数据库、专用的环境变量、自动化的迁移和清理机制，可以确保每次测试都在可控、可重复的环境中运行。接下来的小节将详细介绍每个环节的具体实现。</p>`,11))])}const v=p(k,[["render",c]]);export{y as __pageData,v as default};
