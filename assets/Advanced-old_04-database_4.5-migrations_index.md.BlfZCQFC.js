import{_ as d,C as l,c as r,o as t,a3 as i,b as n,w as e,a as o,G as h,a4 as p}from"./chunks/framework.CUcrqFol.js";const B=JSON.parse('{"title":"4.5 线上数据库动手术——数据库迁移策略：生产环境的变更管理","description":"4.5 线上数据库动手术——数据库迁移策略：生产环境的变更管理 认知重构 生产环境的数据库变更就像给飞行中的飞机换引擎——需要极其谨慎的策略和充分的准备。 为什么迁移很重要？ **迁移失败的后果**： 服务中断 数据丢失 用户流失 子章节导航 | 章节 | 主题 | 核心问题 | |------|------|----","frontmatter":{"title":"4.5 线上数据库动手术——数据库迁移策略：生产环境的变更管理","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/04-database/4.5-migrations/index.md","filePath":"Advanced-old/04-database/4.5-migrations/index.md","lastUpdated":1766168364000}'),c={name:"Advanced-old/04-database/4.5-migrations/index.md"};function E(g,a,k,b,m,u){const s=l("Mermaid");return t(),r("div",null,[a[1]||(a[1]=i('<h1 id="_4-5-线上数据库动手术——数据库迁移策略-生产环境的变更管理" tabindex="-1">4.5 线上数据库动手术——数据库迁移策略：生产环境的变更管理 <a class="header-anchor" href="#_4-5-线上数据库动手术——数据库迁移策略-生产环境的变更管理" aria-label="Permalink to &quot;4.5 线上数据库动手术——数据库迁移策略：生产环境的变更管理&quot;">​</a></h1><h3 id="认知重构" tabindex="-1">认知重构 <a class="header-anchor" href="#认知重构" aria-label="Permalink to &quot;认知重构&quot;">​</a></h3><p>生产环境的数据库变更就像给飞行中的飞机换引擎——需要极其谨慎的策略和充分的准备。</p><h3 id="为什么迁移很重要" tabindex="-1">为什么迁移很重要？ <a class="header-anchor" href="#为什么迁移很重要" aria-label="Permalink to &quot;为什么迁移很重要？&quot;">​</a></h3>',4)),(t(),n(p,null,{default:e(()=>[h(s,{id:"mermaid-12",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20A%5B%22%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%22%5D%20--%3E%20B%5B%22%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%22%5D%0A%20%20%20%20B%20--%3E%20C%5B%22%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%22%5D%0A%20%20%20%20%0A%20%20%20%20D%5B%22Schema%20%E5%8F%98%E6%9B%B4%22%5D%20--%3E%20E%7B%22%E5%AE%89%E5%85%A8%E5%90%97%EF%BC%9F%22%7D%0A%20%20%20%20E%20--%20%22%E6%98%AF%22%20--%3E%20F%5B%22%E5%BA%94%E7%94%A8%E8%BF%81%E7%A7%BB%22%5D%0A%20%20%20%20E%20--%20%22%E5%90%A6%22%20--%3E%20G%5B%22%E5%9B%9E%E6%BB%9A%2F%E4%BF%AE%E5%A4%8D%22%5D%0A"})]),fallback:e(()=>[...a[0]||(a[0]=[o(" Loading... ",-1)])]),_:1})),a[2]||(a[2]=i('<p><strong>迁移失败的后果</strong>：</p><ul><li>服务中断</li><li>数据丢失</li><li>用户流失</li></ul><h3 id="子章节导航" tabindex="-1">子章节导航 <a class="header-anchor" href="#子章节导航" aria-label="Permalink to &quot;子章节导航&quot;">​</a></h3><table tabindex="0"><thead><tr><th>章节</th><th>主题</th><th>核心问题</th></tr></thead><tbody><tr><td>4.5.1</td><td>环境同步</td><td>如何保证开发/测试/生产环境一致？</td></tr><tr><td>4.5.2</td><td>回滚机制</td><td>迁移失败了怎么恢复？</td></tr><tr><td>4.5.3</td><td>数据迁移</td><td>改表结构时数据怎么处理？</td></tr></tbody></table><h3 id="迁移的基本原则" tabindex="-1">迁移的基本原则 <a class="header-anchor" href="#迁移的基本原则" aria-label="Permalink to &quot;迁移的基本原则&quot;">​</a></h3><ol><li><strong>先备份</strong>：生产环境迁移前必须备份</li><li><strong>先测试</strong>：在测试环境验证迁移脚本</li><li><strong>小步快跑</strong>：大变更拆分成多个小迁移</li><li><strong>可回滚</strong>：每次迁移都要有回滚方案</li></ol><h3 id="prisma-迁移工作流" tabindex="-1">Prisma 迁移工作流 <a class="header-anchor" href="#prisma-迁移工作流" aria-label="Permalink to &quot;Prisma 迁移工作流&quot;">​</a></h3><p><strong>开发环境</strong>：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prisma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add_user_role</span></span></code></pre></div><p><strong>生产环境</strong>：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prisma</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> migrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span></span></code></pre></div><table tabindex="0"><thead><tr><th>命令</th><th>环境</th><th>作用</th></tr></thead><tbody><tr><td><code>migrate dev</code></td><td>开发</td><td>生成并应用迁移</td></tr><tr><td><code>migrate deploy</code></td><td>生产</td><td>只应用已有迁移</td></tr><tr><td><code>migrate reset</code></td><td>开发</td><td>重置数据库</td></tr></tbody></table><h3 id="迁移前检查清单" tabindex="-1">迁移前检查清单 <a class="header-anchor" href="#迁移前检查清单" aria-label="Permalink to &quot;迁移前检查清单&quot;">​</a></h3><ul><li>[ ] 已在本地测试迁移</li><li>[ ] 已在测试环境验证</li><li>[ ] 已备份生产数据库</li><li>[ ] 了解迁移的预计执行时间</li><li>[ ] 准备好回滚方案</li><li>[ ] 安排在低峰期执行</li></ul><h3 id="本章小结" tabindex="-1">本章小结 <a class="header-anchor" href="#本章小结" aria-label="Permalink to &quot;本章小结&quot;">​</a></h3><ul><li>生产迁移需要谨慎策略</li><li>使用 <code>migrate deploy</code> 部署生产环境</li><li>始终先备份、先测试</li><li>准备回滚方案应对失败</li></ul>',16))])}const A=d(c,[["render",E]]);export{B as __pageData,A as default};
