import{_ as e,C as E,c as r,o as a,a3 as n,b as l,w as i,a as t,G as k,a4 as p}from"./chunks/framework.CUcrqFol.js";const C=JSON.parse('{"title":"11.4.4 ä¸‹æ¬¡å¦‚ä½•é¿å…â€”â€”é¢„é˜²æªæ–½ï¼šæµç¨‹æ”¹è¿›ä¸ç›‘æ§åŠ å¼º","description":"11.4.4 é¢„é˜²æªæ–½ï¼šæµç¨‹æ”¹è¿›ä¸ç›‘æ§åŠ å¼º ä¸€å¥è¯ç ´é¢˜ å¥½çš„é¢„é˜²æªæ–½è¦è®©**åŒç±»é—®é¢˜æ— æ³•å†æ¬¡å‘ç”Ÿ**ï¼Œè€Œä¸åªæ˜¯\\"ä¸‹æ¬¡å°å¿ƒç‚¹\\"ã€‚ æ ¸å¿ƒä»·å€¼ åˆ¶å®šé¢„é˜²æªæ–½èƒ½è®©ä½ ï¼š æŠŠæ•…éšœè½¬åŒ–ä¸ºç³»ç»Ÿæ”¹è¿› å»ºç«‹é˜²å¾¡æ€§çš„å·¥ç¨‹æ–‡åŒ– æŒç»­æé«˜ç³»ç»Ÿå¯é æ€§ é¢„é˜²æªæ–½çš„å±‚æ¬¡ æŠ€æœ¯å±‚é¢çš„é¢„é˜² æ·»åŠ ç›‘æ§å‘Šè­¦ æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯• æ·»åŠ å®¹é”™è®¾è®¡ æµç¨‹å±‚é¢çš„é¢„é˜² ä»£ç ","frontmatter":{"title":"11.4.4 ä¸‹æ¬¡å¦‚ä½•é¿å…â€”â€”é¢„é˜²æªæ–½ï¼šæµç¨‹æ”¹è¿›ä¸ç›‘æ§åŠ å¼º","typora-root-url":"../../public"},"headers":[],"relativePath":"Advanced-old/11-review/11.4-post-mortem/11.4.4-prevention.md","filePath":"Advanced-old/11-review/11.4-post-mortem/11.4.4-prevention.md","lastUpdated":1766168364000}'),d={name:"Advanced-old/11-review/11.4-post-mortem/11.4.4-prevention.md"};function g(y,s,o,F,c,A){const h=E("Mermaid");return a(),r("div",null,[s[2]||(s[2]=n('<h1 id="_11-4-4-é¢„é˜²æªæ–½-æµç¨‹æ”¹è¿›ä¸ç›‘æ§åŠ å¼º" tabindex="-1">11.4.4 é¢„é˜²æªæ–½ï¼šæµç¨‹æ”¹è¿›ä¸ç›‘æ§åŠ å¼º <a class="header-anchor" href="#_11-4-4-é¢„é˜²æªæ–½-æµç¨‹æ”¹è¿›ä¸ç›‘æ§åŠ å¼º" aria-label="Permalink to &quot;11.4.4 é¢„é˜²æªæ–½ï¼šæµç¨‹æ”¹è¿›ä¸ç›‘æ§åŠ å¼º&quot;">â€‹</a></h1><h2 id="ä¸€å¥è¯ç ´é¢˜" tabindex="-1">ä¸€å¥è¯ç ´é¢˜ <a class="header-anchor" href="#ä¸€å¥è¯ç ´é¢˜" aria-label="Permalink to &quot;ä¸€å¥è¯ç ´é¢˜&quot;">â€‹</a></h2><p>å¥½çš„é¢„é˜²æªæ–½è¦è®©<strong>åŒç±»é—®é¢˜æ— æ³•å†æ¬¡å‘ç”Ÿ</strong>ï¼Œè€Œä¸åªæ˜¯&quot;ä¸‹æ¬¡å°å¿ƒç‚¹&quot;ã€‚</p><h2 id="æ ¸å¿ƒä»·å€¼" tabindex="-1">æ ¸å¿ƒä»·å€¼ <a class="header-anchor" href="#æ ¸å¿ƒä»·å€¼" aria-label="Permalink to &quot;æ ¸å¿ƒä»·å€¼&quot;">â€‹</a></h2><p>åˆ¶å®šé¢„é˜²æªæ–½èƒ½è®©ä½ ï¼š</p><ul><li>æŠŠæ•…éšœè½¬åŒ–ä¸ºç³»ç»Ÿæ”¹è¿›</li><li>å»ºç«‹é˜²å¾¡æ€§çš„å·¥ç¨‹æ–‡åŒ–</li><li>æŒç»­æé«˜ç³»ç»Ÿå¯é æ€§</li></ul><h2 id="é¢„é˜²æªæ–½çš„å±‚æ¬¡" tabindex="-1">é¢„é˜²æªæ–½çš„å±‚æ¬¡ <a class="header-anchor" href="#é¢„é˜²æªæ–½çš„å±‚æ¬¡" aria-label="Permalink to &quot;é¢„é˜²æªæ–½çš„å±‚æ¬¡&quot;">â€‹</a></h2>',7)),(a(),l(p,null,{default:i(()=>[k(h,{id:"mermaid-35",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20A%5B%22%E9%A2%84%E9%98%B2%E6%8E%AA%E6%96%BD%22%5D%20--%3E%20B%5B%22%E6%8A%80%E6%9C%AF%E5%B1%82%E9%9D%A2%22%5D%0A%20%20%20%20A%20--%3E%20C%5B%22%E6%B5%81%E7%A8%8B%E5%B1%82%E9%9D%A2%22%5D%0A%20%20%20%20A%20--%3E%20D%5B%22%E6%96%87%E5%8C%96%E5%B1%82%E9%9D%A2%22%5D%0A%20%20%20%20%0A%20%20%20%20B%20--%3E%20B1%5B%22%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A3%80%E6%B5%8B%22%5D%0A%20%20%20%20B%20--%3E%20B2%5B%22%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%22%5D%0A%20%20%20%20B%20--%3E%20B3%5B%22%E5%AE%B9%E9%94%99%E8%AE%BE%E8%AE%A1%22%5D%0A%20%20%20%20%0A%20%20%20%20C%20--%3E%20C1%5B%22%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5%22%5D%0A%20%20%20%20C%20--%3E%20C2%5B%22%E6%B5%8B%E8%AF%95%E8%A7%84%E8%8C%83%22%5D%0A%20%20%20%20C%20--%3E%20C3%5B%22%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B%22%5D%0A%20%20%20%20%0A%20%20%20%20D%20--%3E%20D1%5B%22%E5%A4%8D%E7%9B%98%E6%96%87%E5%8C%96%22%5D%0A%20%20%20%20D%20--%3E%20D2%5B%22%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB%22%5D%0A%20%20%20%20D%20--%3E%20D3%5B%22%E5%AE%89%E5%85%A8%E6%84%8F%E8%AF%86%22%5D%0A"})]),fallback:i(()=>[...s[0]||(s[0]=[t(" Loading... ",-1)])]),_:1})),s[3]||(s[3]=n(`<h2 id="æŠ€æœ¯å±‚é¢çš„é¢„é˜²" tabindex="-1">æŠ€æœ¯å±‚é¢çš„é¢„é˜² <a class="header-anchor" href="#æŠ€æœ¯å±‚é¢çš„é¢„é˜²" aria-label="Permalink to &quot;æŠ€æœ¯å±‚é¢çš„é¢„é˜²&quot;">â€‹</a></h2><h3 id="æ·»åŠ ç›‘æ§å‘Šè­¦" tabindex="-1">æ·»åŠ ç›‘æ§å‘Šè­¦ <a class="header-anchor" href="#æ·»åŠ ç›‘æ§å‘Šè­¦" aria-label="Permalink to &quot;æ·»åŠ ç›‘æ§å‘Šè­¦&quot;">â€‹</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># prometheus/rules/database.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groups</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">database</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    rules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">alert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">HighConnectionPoolUsage</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        expr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">db_pool_active / db_pool_max &gt; 0.8</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5m</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          severity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">warning</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          summary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">alert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SlowQuery</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        expr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">db_query_duration_seconds &gt; 1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1m</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          severity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">warning</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          summary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;æ£€æµ‹åˆ°æ…¢æŸ¥è¯¢&quot;</span></span></code></pre></div><h3 id="æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•" tabindex="-1">æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯• <a class="header-anchor" href="#æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•" aria-label="Permalink to &quot;æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•&quot;">â€‹</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// __tests__/performance/login.test.ts</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">describe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Login Performance&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;should complete login within 500ms&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> start</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> login</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ email: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;test@example.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, password: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;password&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> duration</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(duration).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toBeLessThan</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;should handle 100 concurrent logins&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> requests</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      login</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ email: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;test@example.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, password: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;password&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> results</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">allSettled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(requests)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> failures</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> results.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;rejected&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(failures.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toBeLessThan</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å…è®¸ 5% å¤±è´¥ç‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h3 id="æ·»åŠ å®¹é”™è®¾è®¡" tabindex="-1">æ·»åŠ å®¹é”™è®¾è®¡ <a class="header-anchor" href="#æ·»åŠ å®¹é”™è®¾è®¡" aria-label="Permalink to &quot;æ·»åŠ å®¹é”™è®¾è®¡&quot;">â€‹</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lib/database.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { retry } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@lifeomic/attempt&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> queryWithRetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  queryFn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { maxAttempts: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, delay: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> retry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(queryFn, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    maxAttempts: options.maxAttempts,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    delay: options.delay,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    factor: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æŒ‡æ•°é€€é¿</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    handleError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Query failed, attempt \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">attemptNum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="æµç¨‹å±‚é¢çš„é¢„é˜²" tabindex="-1">æµç¨‹å±‚é¢çš„é¢„é˜² <a class="header-anchor" href="#æµç¨‹å±‚é¢çš„é¢„é˜²" aria-label="Permalink to &quot;æµç¨‹å±‚é¢çš„é¢„é˜²&quot;">â€‹</a></h2><h3 id="ä»£ç å®¡æŸ¥æ¸…å•" tabindex="-1">ä»£ç å®¡æŸ¥æ¸…å• <a class="header-anchor" href="#ä»£ç å®¡æŸ¥æ¸…å•" aria-label="Permalink to &quot;ä»£ç å®¡æŸ¥æ¸…å•&quot;">â€‹</a></h3><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">## PR Review Checklist</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">### æ€§èƒ½</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] æ˜¯å¦æœ‰ N+1 æŸ¥è¯¢é—®é¢˜ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] æ˜¯å¦è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Ÿ</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">### å¯è§‚æµ‹æ€§</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] æ˜¯å¦æ·»åŠ äº†å¿…è¦çš„æ—¥å¿—ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] æ˜¯å¦æ·»åŠ äº†ç›‘æ§æŒ‡æ ‡ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] é”™è¯¯æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ï¼Ÿ</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">### å®¹é”™</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] å¤–éƒ¨ä¾èµ–å¤±è´¥æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ ] æ˜¯å¦æœ‰é™çº§æ–¹æ¡ˆï¼Ÿ</span></span></code></pre></div><h3 id="å‘å¸ƒæµç¨‹æ”¹è¿›" tabindex="-1">å‘å¸ƒæµç¨‹æ”¹è¿› <a class="header-anchor" href="#å‘å¸ƒæµç¨‹æ”¹è¿›" aria-label="Permalink to &quot;å‘å¸ƒæµç¨‹æ”¹è¿›&quot;">â€‹</a></h3>`,11)),(a(),l(p,null,{default:i(()=>[k(h,{id:"mermaid-61",class:"mermaid",graph:"flowchart%20LR%0A%20%20%20%20A%5B%22%E4%BB%A3%E7%A0%81%E5%90%88%E5%B9%B6%22%5D%20--%3E%20B%5B%22%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%22%5D%0A%20%20%20%20B%20--%3E%20C%5B%22%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%2010%25%22%5D%0A%20%20%20%20C%20--%3E%20D%7B%22%E7%9B%91%E6%8E%A7%E6%AD%A3%E5%B8%B8%3F%22%7D%0A%20%20%20%20D%20--%3E%7C%E6%98%AF%7C%20E%5B%22%E6%89%A9%E5%A4%A7%E5%88%B0%2050%25%22%5D%0A%20%20%20%20D%20--%3E%7C%E5%90%A6%7C%20F%5B%22%E8%87%AA%E5%8A%A8%E5%9B%9E%E6%BB%9A%22%5D%0A%20%20%20%20E%20--%3E%20G%7B%22%E7%9B%91%E6%8E%A7%E6%AD%A3%E5%B8%B8%3F%22%7D%0A%20%20%20%20G%20--%3E%7C%E6%98%AF%7C%20H%5B%22%E5%85%A8%E9%87%8F%E5%8F%91%E5%B8%83%22%5D%0A%20%20%20%20G%20--%3E%7C%E5%90%A6%7C%20F%0A"})]),fallback:i(()=>[...s[1]||(s[1]=[t(" Loading... ",-1)])]),_:1})),s[4]||(s[4]=n(`<h2 id="é¢„é˜²æªæ–½è·Ÿè¸ªè¡¨" tabindex="-1">é¢„é˜²æªæ–½è·Ÿè¸ªè¡¨ <a class="header-anchor" href="#é¢„é˜²æªæ–½è·Ÿè¸ªè¡¨" aria-label="Permalink to &quot;é¢„é˜²æªæ–½è·Ÿè¸ªè¡¨&quot;">â€‹</a></h2><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">## æ”¹è¿›æªæ–½è·Ÿè¸ª</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| æªæ–½ | ç±»å‹ | è´Ÿè´£äºº | æˆªæ­¢æ—¥æœŸ | çŠ¶æ€ | éªŒè¯æ–¹å¼ |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|------|------|--------|----------|------|----------|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| æ·»åŠ è¿æ¥æ± ç›‘æ§ | æŠ€æœ¯ | å¼ ä¸‰ | 1æœˆ20æ—¥ | âœ… å®Œæˆ | Grafana çœ‹æ¿ |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| æ·»åŠ æ€§èƒ½æµ‹è¯• | æµç¨‹ | æå›› | 1æœˆ25æ—¥ | ğŸ”„ è¿›è¡Œä¸­ | CI é›†æˆ |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| æ›´æ–° Review æ¸…å• | æµç¨‹ | ç‹äº” | 1æœˆ22æ—¥ | â³ å¾…å¼€å§‹ | æ–‡æ¡£æ›´æ–° |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">| å¤ç›˜åˆ†äº«ä¼š | æ–‡åŒ– | èµµå…­ | 1æœˆ30æ—¥ | â³ å¾…å¼€å§‹ | ä¼šè®®è®°å½• |</span></span></code></pre></div><h2 id="é¿å‘æŒ‡å—" tabindex="-1">é¿å‘æŒ‡å— <a class="header-anchor" href="#é¿å‘æŒ‡å—" aria-label="Permalink to &quot;é¿å‘æŒ‡å—&quot;">â€‹</a></h2><div class="danger custom-block"><p class="custom-block-title">æ–°æ‰‹æœ€å®¹æ˜“çŠ¯çš„é”™</p><ol><li>é¢„é˜²æªæ–½å¤ªç©ºæ³›ï¼ˆå¦‚&quot;åŠ å¼ºç›‘æ§&quot;ï¼‰</li><li>æ²¡æœ‰æ˜ç¡®è´Ÿè´£äººå’Œæˆªæ­¢æ—¥æœŸ</li><li>åˆ¶å®šäº†æªæ–½ä½†æ²¡æœ‰è·Ÿè¸ªè½å®</li><li>åªå…³æ³¨æŠ€æœ¯æªæ–½ï¼Œå¿½ç•¥æµç¨‹å’Œæ–‡åŒ–</li></ol></div>`,4))])}const D=e(d,[["render",g]]);export{C as __pageData,D as default};
